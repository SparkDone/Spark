---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import "../styles/variables.css";
import "../styles/markdown-extend.css";
import "../styles/components/layout.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import ResourceHints from "@components/ResourceHints.astro";
import SecurityHeaders from "@components/SecurityHeaders.astro";
import FontPreloader from "@components/FontPreloader.astro";
import { profileConfig, siteConfig } from "@/config";
import {
	AUTO_MODE,
	// BANNER_HEIGHT, // Bannerå·²åˆ é™¤
	// BANNER_HEIGHT_EXTEND, // Bannerå·²åˆ é™¤
	// BANNER_HEIGHT_HOME, // Bannerå·²åˆ é™¤
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";
import "katex/dist/katex.css";
import { getIndexSettings } from "../lib/strapi";
import { getSiteConfig } from "../lib/config-integration";

interface Props {
	title?: string;
	// banner?: string; // Bannerå·²åˆ é™¤
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	author?: string;
}

let { title, /* banner, */ description, lang, setOGTypeArticle, author } = Astro.props;

// è·å–æ•´åˆåçš„ç«™ç‚¹é…ç½®ï¼ˆStrapi + config.tsï¼‰
const integratedSiteConfig = await getSiteConfig();
const strapiSiteTitle = integratedSiteConfig.title;
const strapiSiteSubtitle = integratedSiteConfig.subtitle;
const strapiSiteDescription = integratedSiteConfig.description || description;

// è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log('ğŸ”§ Layout.astro é…ç½®è°ƒè¯•:', {
    integratedSiteConfig,
    strapiSiteTitle,
    strapiSiteSubtitle,
    strapiSiteDescription
  });
}

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;
// Bannerç›¸å…³ä»£ç å·²åˆ é™¤
// if (!banner || typeof banner !== "string" || banner.trim() === "") {
//	banner = siteConfig.banner.src;
// }
// banner = siteConfig.banner.src;
// const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	// å†…å®¹é¡µé¢ï¼šé¡µé¢æ ‡é¢˜ - ç½‘ç«™åç§°
	pageTitle = `${title} - ${strapiSiteTitle}`;
} else {
	// é¦–é¡µï¼šç½‘ç«™åç§° - ç½‘ç«™å‰¯æ ‡é¢˜ï¼ˆå¦‚æœæœ‰å‰¯æ ‡é¢˜çš„è¯ï¼‰
	if (strapiSiteSubtitle && strapiSiteSubtitle.trim() !== '') {
		pageTitle = `${strapiSiteTitle} - ${strapiSiteSubtitle}`;
	} else {
		pageTitle = strapiSiteTitle;
	}
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

// Banner offsetç›¸å…³ä»£ç å·²åˆ é™¤
// const bannerOffsetByPosition = {
//	top: `${BANNER_HEIGHT_EXTEND}vh`,
//	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
//	bottom: "0",
// };
// const bannerOffset = bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>
		<!-- å®‰å…¨å¤´ - å¿…é¡»åœ¨æœ€å‰é¢ -->
		<SecurityHeaders />

		<!-- å­—ä½“é¢„åŠ è½½ - å…³é”®æ€§èƒ½ä¼˜åŒ– -->
		<FontPreloader />

		<!-- ç¯å¢ƒæ„ŸçŸ¥çš„èµ„æºé¢„åŠ è½½ -->
		<ResourceHints />

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content={strapiSiteDescription || description || pageTitle}>
		<meta name="author" content={author || profileConfig.name}>
		<meta name="robots" content="index, follow">
		<meta name="googlebot" content="index, follow">

		<!-- è¯­è¨€å’Œåœ°åŒº -->
		<meta name="language" content={lang || "zh-CN"}>
		<meta property="og:locale" content={lang || "zh_CN"}>

		<meta property="og:site_name" content={strapiSiteTitle}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={strapiSiteDescription || description || pageTitle}>
		<meta property="og:type" content={setOGTypeArticle ? "article" : "website"}>
		<!-- Banner OG imageå·²åˆ é™¤ -->
		<!-- {banner && <meta property="og:image" content={new URL(banner, Astro.site).href}>} -->

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={strapiSiteDescription || description || pageTitle}>
		<!-- Banner Twitter imageå·²åˆ é™¤ -->
		<!-- {banner && <meta name="twitter:image" content={new URL(banner, Astro.site).href}>} -->

		<!-- Canonical URL -->
		<link rel="canonical" href={Astro.url.href}>
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- ä¸»é¢˜åˆå§‹åŒ– - å¿…é¡»åœ¨é¡µé¢æ¸²æŸ“å‰æ‰§è¡Œä»¥é¿å…é—ªçƒ -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, configHue}}>
			// æ¨¡å—åŒ–çš„ä¸»é¢˜ç®¡ç†é€»è¾‘ï¼ˆå†…è”ç‰ˆæœ¬ï¼Œé¿å…é—ªçƒï¼‰
			(function initializeTheme() {
				// é˜²æ­¢é‡å¤åˆå§‹åŒ–
				if (window.themeInitialized) {
					return;
				}
				window.themeInitialized = true;

				// Load the theme from local storage, é»˜è®¤ä¸ºæš—é»‘æ¨¡å¼
				const theme = localStorage.getItem('theme') || DEFAULT_THEME;

				// å¦‚æœæ˜¯é¦–æ¬¡è®¿é—®ä¸”æ²¡æœ‰è®¾ç½®ä¸»é¢˜ï¼Œè®¾ç½®ä¸ºæš—é»‘æ¨¡å¼
				if (!localStorage.getItem('theme')) {
					localStorage.setItem('theme', DARK_MODE);
				}

				switch (theme) {
					case LIGHT_MODE:
						document.documentElement.classList.remove('dark');
						break;
					case DARK_MODE:
						document.documentElement.classList.add('dark');
						break;
					case AUTO_MODE:
						if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
							document.documentElement.classList.add('dark');
						} else {
							document.documentElement.classList.remove('dark');
						}
						break;
					default:
						// é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æš—é»‘æ¨¡å¼
						document.documentElement.classList.add('dark');
						localStorage.setItem('theme', DARK_MODE);
				}

				// Load the hue from local storage
				const hue = localStorage.getItem('hue') || configHue;
				document.documentElement.style.setProperty('--hue', hue);

				// é¢„è®¾é¡µé¢è½¬æ¢ä¼˜åŒ–
				document.documentElement.style.setProperty('--content-delay', '0ms');

				// æ ‡è®°é¡µé¢å·²å‡†å¤‡å¥½ï¼Œé¿å…Swupé‡å¤åˆå§‹åŒ–
				document.documentElement.setAttribute('data-theme-ready', 'true');


			})();
		</script>


		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

		<!-- é¡µé¢å·¥å…·è„šæœ¬ -->
		<script is:inline src="/js/page-utils.js"></script>

		<!-- åˆ†ç±»é¢„çƒ­è„šæœ¬ -->
		<script is:inline src="/js/category-preheater.js"></script>

		<!-- åˆå§‹åŒ–ç®¡ç†å™¨ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
		<script is:inline src="/js/init-manager.js"></script>

		<!-- WebAssemblyå…¼å®¹æ€§æ£€æŸ¥ -->
		<script is:inline src="/js/wasm-compatibility.js"></script>

		<!-- å…¨å±€é”™è¯¯å¤„ç†å™¨ -->
		<script is:inline src="/js/error-handler.js"></script>

		<!-- æ€§èƒ½ç›‘æ§è„šæœ¬ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ - æš‚æ—¶ç¦ç”¨ä»¥é¿å…ç•Œé¢å¹²æ‰° -->
		{false && import.meta.env.DEV && (
			<>
				<script is:inline src="/js/performance-monitor.js"></script>
				<script is:inline src="/js/theme-performance-monitor.js"></script>
				<script is:inline src="/js/resource-preload-monitor.js"></script>
				<script is:inline src="/js/preload-validator.js"></script>
			</>
		)}

	</head>
	<body class="transition" class:list={[{"lg:is-home": isHomePage /* , "enable-banner": enableBanner */}]}
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>


	</body>
</html>

<!-- Banner CSSæ ·å¼å·²åˆ é™¤ -->

<!-- å­—ä½“åŠ è½½å’Œé”™è¯¯å¤„ç† - ä½¿ç”¨å†…è”ç‰ˆæœ¬ç¡®ä¿ç«‹å³æ‰§è¡Œ -->
<script is:inline>
/* å¼•ç”¨å¤–éƒ¨é¡µé¢å·¥å…·è„šæœ¬ */


</script>

<script>
import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
// Bannerå¸¸é‡å¯¼å…¥å·²åˆ é™¤
// import {
//	BANNER_HEIGHT,
//	BANNER_HEIGHT_HOME,
//	BANNER_HEIGHT_EXTEND,
//	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
// } from "../constants/constants";
import { siteConfig } from '../config';



/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

// const bannerEnabled = !!document.getElementById('banner-wrapper') // Bannerå·²åˆ é™¤

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) {
				return;
			}
		}
		if (panelDom) {
			panelDom.classList.add("float-panel-closed");
		}
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])
// ç§»é™¤ä¸»é¢˜é¢æ¿çš„ç‚¹å‡»å¤–éƒ¨å…³é—­ï¼Œå› ä¸ºå·²ç»æ²¡æœ‰é¢æ¿äº†


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

function initCustomScrollbar() {
	// é˜²æ­¢é‡å¤åˆå§‹åŒ–
	if (window.customScrollbarInitialized) {
		return;
	}

	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;

	// å®Œå…¨å»¶è¿ŸOverlayScrollbarsåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
	// åªåœ¨ç”¨æˆ·äº¤äº’åæ‰åˆå§‹åŒ–ï¼Œæå‡é¦–æ¬¡åŠ è½½æ€§èƒ½
	const initScrollbarOnInteraction = () => {
		try {
			OverlayScrollbars(
				{
					target: bodyElement,
					cancel: {
						nativeScrollbarsOverlaid: true,
					}
				}, {
				scrollbars: {
					theme: 'scrollbar-base scrollbar-auto py-1',
					autoHide: 'leave',
					autoHideDelay: 300,
					autoHideSuspend: false,
					visibility: 'auto',
				},
				overflow: {
					x: 'hidden',
					y: 'scroll'
				}
			});

			window.customScrollbarInitialized = true;
		} catch (error) {
			console.warn('âš ï¸ è‡ªå®šä¹‰æ»šåŠ¨æ¡åˆå§‹åŒ–å¤±è´¥:', error);
		}
	};

	// åœ¨ç”¨æˆ·é¦–æ¬¡æ»šåŠ¨æˆ–ç‚¹å‡»æ—¶åˆå§‹åŒ–
	const initOnce = () => {
		initScrollbarOnInteraction();
		// ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
		window.removeEventListener('scroll', initOnce);
		window.removeEventListener('click', initOnce);
		window.removeEventListener('touchstart', initOnce);
	};

	// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
	window.addEventListener('scroll', initOnce, { passive: true, once: true });
	window.addEventListener('click', initOnce, { passive: true, once: true });
	window.addEventListener('touchstart', initOnce, { passive: true, once: true });

	// å¤‡ç”¨æ–¹æ¡ˆï¼š5ç§’åè‡ªåŠ¨åˆå§‹åŒ–
	setTimeout(initOnce, 5000);

	const katexElements = document.querySelectorAll('.katex-display') as NodeListOf<HTMLElement>;

	const katexObserverOptions = {
		root: null,
		rootMargin: '100px',
		threshold: 0.1
	};

	const processKatexElement = (element: HTMLElement) => {
		if (!element.parentNode) return;
		if (element.hasAttribute('data-scrollbar-initialized')) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		container.setAttribute('aria-label', 'scrollable container for formulas');

		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		OverlayScrollbars(container, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto',
				autoHide: 'leave',
				autoHideDelay: 500,
				autoHideSuspend: false
			}
		});

		element.setAttribute('data-scrollbar-initialized', 'true');
	};

	const katexObserver = new IntersectionObserver((entries, observer) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
			processKatexElement(entry.target as HTMLElement);
			observer.unobserve(entry.target);
			}
		});
	}, katexObserverOptions);

	katexElements.forEach(element => {
		katexObserver.observe(element);
	});
}

// showBannerå‡½æ•°å·²åˆ é™¤
// function showBanner() { ... }

function init() {
	// é˜²æ­¢é‡å¤åˆå§‹åŒ–
	if (window.layoutInitialized) {
		return;
	}

	// ç«‹å³æ‰§è¡Œå…³é”®åˆå§‹åŒ–
	loadTheme();
	loadHue();

	// æš‚æ—¶ç¦ç”¨è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼Œæµ‹è¯•fixedå®šä½é—®é¢˜
	// requestAnimationFrame(() => {
	//	initCustomScrollbar();
	// });

	window.layoutInitialized = true;
}

/* Load settings when entering the site */
// ä¼˜åŒ–åˆå§‹åŒ–æ—¶æœºï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', () => {
		// å»¶è¿Ÿæ‰§è¡Œï¼Œè®©é¡µé¢å…ˆå®ŒæˆåŸºæœ¬æ¸²æŸ“
		setTimeout(init, 50);
	});
} else {
	// é¡µé¢å·²åŠ è½½ï¼Œå»¶è¿Ÿæ‰§è¡Œé¿å…é˜»å¡
	setTimeout(init, 50);
}

const setup = () => {
	// é¢„çƒ­Swupï¼Œå‡å°‘é¦–æ¬¡ç‚¹å‡»å»¶è¿Ÿ
	window.swup.hooks.on('enable', () => {
		// é¢„å…ˆè®¾ç½®ä¸€äº›æ ·å¼ï¼Œé¿å…é¦–æ¬¡ç‚¹å‡»æ—¶çš„é—ªçƒ
		document.documentElement.style.setProperty('--content-delay', '0ms')
		// æ ‡è®°Swupå·²å‡†å¤‡å¥½
		document.documentElement.setAttribute('data-swup-ready', 'true')

	})

	// ä¼˜åŒ–é¦–æ¬¡ç‚¹å‡»ï¼Œé¿å…å®Œæ•´é¡µé¢é‡æ–°åŠ è½½
	window.swup.hooks.on('animation:out:start', () => {
		// ç¡®ä¿é¡µé¢è½¬æ¢åŠ¨ç”»æµç•…
		document.documentElement.classList.add('is-animating')
	})
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// é¢„å…ˆå‡†å¤‡é¡µé¢è½¬æ¢ï¼Œå‡å°‘é¦–æ¬¡ç‚¹å‡»çš„å»¶è¿Ÿ
		document.documentElement.classList.add('is-changing')
	})
	// æš‚æ—¶ç¦ç”¨è‡ªå®šä¹‰æ»šåŠ¨æ¡
	// window.swup.hooks.on('content:replace', initCustomScrollbar)
	window.swup.hooks.on('content:replace', () => {
		// é˜²æ­¢é‡å¤åˆå§‹åŒ–
		if (window.swupInitializing) {
			return;
		}
		window.swupInitializing = true;

		// é‡æ–°åˆå§‹åŒ–å¸ƒå±€åˆ‡æ¢å™¨
		setTimeout(() => {
			const switcher = document.querySelector('.layout-switcher');
			if (switcher) {
				const defaultLayout = switcher.getAttribute('data-default-layout') || 'grid';
				const targetSelector = switcher.getAttribute('data-target-selector') || '.universal-post-list';

				// æ¸…é™¤æ—§å®ä¾‹
				if (window.universalLayoutSwitcherInstance) {
					window.universalLayoutSwitcherInstance = null;
				}

				// é‡æ–°åˆå§‹åŒ– - æ·»åŠ å®‰å…¨æ£€æŸ¥
				if (typeof window.initUniversalLayoutSwitcher === 'function') {
					window.initUniversalLayoutSwitcher({
						defaultLayout,
						targetSelector
					});


					// ä¼˜åŒ–æœç´¢ç»„ä»¶é‡æ–°åˆå§‹åŒ– - å‡å°‘æ€§èƒ½å¼€é”€
					const searchComponents = document.querySelectorAll('[data-search-component]');
					if (searchComponents.length > 0) {
						// ä½¿ç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
						Promise.resolve().then(() => {
							searchComponents.forEach(component => {
								const event = new CustomEvent('search-reinit');
								component.dispatchEvent(event);
							});
						});
					}
				}
			} else {

				// å»¶è¿Ÿé‡è¯• - é‡æ–°è·å–é…ç½®
				setTimeout(() => {
					const retryswitcher = document.querySelector('.layout-switcher');
					if (retryswitcher && typeof window.initUniversalLayoutSwitcher === 'function') {
						const retryDefaultLayout = retryswitcher.getAttribute('data-default-layout') || 'grid';
						const retryTargetSelector = retryswitcher.getAttribute('data-target-selector') || '.universal-post-list';

						window.initUniversalLayoutSwitcher({
							defaultLayout: retryDefaultLayout,
							targetSelector: retryTargetSelector
						});

					}
				}, 500);
			}

			// é‡ç½®åˆå§‹åŒ–æ ‡å¿—
			setTimeout(() => {
				window.swupInitializing = false;
			}, 200);
		}, 100);
	})
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// Banner heightç›¸å…³ä»£ç å·²åˆ é™¤
		const bodyElement = document.querySelector('body')
		if (pathsEqual(visit.to.url, url('/'))) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}


	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.add('hidden')
		}

		// ç¡®ä¿å¸ƒå±€åˆ‡æ¢å™¨æ­£å¸¸å·¥ä½œ
		setTimeout(() => {
			const switcher = document.querySelector('.layout-switcher');
			const buttons = document.querySelectorAll('.layout-switch-btn');

			if (switcher && buttons.length > 0 && !window.universalLayoutSwitcherInstance) {
				window.forceReinitLayoutSwitcher();
			}
		}, 50);

		// ç¡®ä¿ä¸»é¢˜åˆ‡æ¢å™¨æ­£å¸¸å·¥ä½œ
		setTimeout(() => {
			if (typeof window.reinitThemeSwitch === 'function') {
				window.reinitThemeSwitch();
			}
		}, 50); // å‡å°‘å»¶è¿Ÿï¼Œæ›´å¿«é‡æ–°åˆå§‹åŒ–
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}


        }, 50)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let navbar = document.getElementById('navbar-wrapper')
function scrollFunction() {
	// let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100) // Bannerå·²åˆ é™¤
	let scrollThreshold = 200; // å›ºå®šæ»šåŠ¨é˜ˆå€¼

	if (backToTopBtn) {
		if (document.body.scrollTop > scrollThreshold || document.documentElement.scrollTop > scrollThreshold) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}



	// Bannerç›¸å…³å¯¼èˆªæ éšè—é€»è¾‘å·²åˆ é™¤
}
window.onscroll = scrollFunction

window.onresize = () => {
	// Banner heightè®¡ç®—å·²åˆ é™¤
	// let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	// offset = offset - offset % 4;
	// document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

// ç§»é™¤å†²çªçš„å…¨å±€toggleThemeå‡½æ•°ï¼Œè®©Svelteç»„ä»¶å¤„ç†ä¸»é¢˜åˆ‡æ¢

// å…¨å±€ä¸»é¢˜åˆ‡æ¢å™¨é‡æ–°åˆå§‹åŒ–å‡½æ•°
window.reinitThemeSwitch = function() {
	// è§¦å‘Svelteç»„ä»¶é‡æ–°åˆå§‹åŒ–
	const themeButton = document.getElementById('scheme-switch');
	if (themeButton) {
		// å‘é€è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥Svelteç»„ä»¶é‡æ–°åˆå§‹åŒ–
		const event = new CustomEvent('theme-switch-reinit');
		themeButton.dispatchEvent(event);
		console.log('ğŸ¨ å·²è§¦å‘ä¸»é¢˜åˆ‡æ¢å™¨é‡æ–°åˆå§‹åŒ–äº‹ä»¶');
	}
};

</script>

<script>
import PhotoSwipeLightbox from "photoswipe/lightbox"
import "photoswipe/style.css"

let lightbox: PhotoSwipeLightbox
let pswp = import("photoswipe")

function createPhotoSwipe() {
	lightbox = new PhotoSwipeLightbox({
		gallery: ".custom-md img, #post-cover img",
		pswpModule: () => pswp,
		closeSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z"/></svg>',
		zoomSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M340-540h-40q-17 0-28.5-11.5T260-580q0-17 11.5-28.5T300-620h40v-40q0-17 11.5-28.5T380-700q17 0 28.5 11.5T420-660v40h40q17 0 28.5 11.5T500-580q0 17-11.5 28.5T460-540h-40v40q0 17-11.5 28.5T380-460q-17 0-28.5-11.5T340-500v-40Zm40 220q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>',
		padding: { top: 20, bottom: 20, left: 20, right: 20 },
		wheelToZoom: true,
		arrowPrev: false,
		arrowNext: false,
		imageClickAction: 'close',
		tapAction: 'close',
		doubleTapAction: 'zoom',
	})

	lightbox.addFilter("domItemData", (itemData, element) => {
		if (element instanceof HTMLImageElement) {
			itemData.src = element.src

			itemData.w = Number(element.naturalWidth || window.innerWidth)
			itemData.h = Number(element.naturalHeight || window.innerHeight)

			itemData.msrc = element.src
		}

		return itemData
	})

	lightbox.init()
}

const setup = () => {
	if (!lightbox) {
		createPhotoSwipe()
	}
	window.swup.hooks.on("page:view", () => {
		createPhotoSwipe()
	})

	window.swup.hooks.on(
		"content:replace",
		() => {
			lightbox?.destroy?.()
		},
		{ before: true },
	)
}

if (window.swup) {
	setup()
} else {
	document.addEventListener("swup:enable", setup)
}
</script>
