---
import path from "node:path";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
}

import { Image } from "astro:assets";
import { url } from "../../utils/url-utils";
import { adaptImageUrlSync } from "../../utils/image-adapter";

const { id, src, alt, position = "center", basePath = "/" } = Astro.props;
const className = Astro.props.class;

// ç¡®ä¿ src æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æ˜¯åˆ™ä½¿ç”¨ç©ºå­—ç¬¦ä¸²
const srcString = typeof src === 'string' ? src : '';

// æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æº
const hasValidSrc = srcString && srcString.trim() !== '';



const isLocal = !(
	srcString.startsWith("/") ||
	srcString.startsWith("http") ||
	srcString.startsWith("https") ||
	srcString.startsWith("data:")
);
const isPublic = srcString.startsWith("/");
const isNetwork = srcString.startsWith("http") || srcString.startsWith("https");



// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>("../../**", {
		import: "default",
	});

	// å¤„ç†ä¸åŒçš„è·¯å¾„æ ¼å¼
	let normalizedPath;
	if (srcString.startsWith("src/")) {
		// å¦‚æœè·¯å¾„ä»¥ src/ å¼€å¤´ï¼Œç›´æ¥ä½¿ç”¨
		normalizedPath = path.normalize(path.join("../../", srcString)).replace(/\\/g, "/");
	} else if (srcString.startsWith("assets/")) {
		// å¦‚æœè·¯å¾„ä»¥ assets/ å¼€å¤´ï¼Œæ·»åŠ  src/ å‰ç¼€
		normalizedPath = path.normalize(path.join("../../src/", srcString)).replace(/\\/g, "/");
	} else {
		// å…¶ä»–æƒ…å†µï¼Œä½¿ç”¨ basePath
		normalizedPath = path.normalize(path.join("../../", basePath, srcString)).replace(/\\/g, "/");
	}

	// åªåœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰“å°è°ƒè¯•ä¿¡æ¯
	if (import.meta.env.DEV) {
		console.log(`ğŸ–¼ï¸ å°è¯•åŠ è½½å›¾ç‰‡: ${normalizedPath}`);
		console.log(`ğŸ–¼ï¸ basePath: ${basePath}, srcString: ${srcString}`);
	}

	const file = files[normalizedPath];
	if (!file) {
		if (import.meta.env.DEV) {
			console.error(
				`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
			);
			console.log(`ğŸ–¼ï¸ å¯ç”¨æ–‡ä»¶åˆ—è¡¨:`, Object.keys(files).slice(0, 10));
		}
	} else {
		img = await file();
	}
}

const isBanner = id === 'banner';
const imageClass = isBanner ? "w-full h-full object-cover" : "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
---
{hasValidSrc && (
<div id={id} class:list={[className, 'overflow-hidden relative']}>
    <!-- ç§»é™¤Bannerçš„å åŠ å±‚ï¼Œä¿æŒå…¶ä»–å›¾ç‰‡çš„å åŠ å±‚ -->
    {!isBanner && <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>}

    {isLocal && img && <Image
        src={img}
        alt={alt || ""}
        class={imageClass}
        style={imageStyle}
        quality={isBanner ? 95 : 80}
        format="webp"
        loading={isBanner ? "eager" : "lazy"}
        decoding={isBanner ? "sync" : "async"}
        width={isBanner ? 1920 : undefined}
        height={isBanner ? 1080 : undefined}
    />}
    {!isLocal && <img
        src={adaptImageUrlSync(srcString)}
        alt={alt || ""}
        class={imageClass}
        style={imageStyle}
        loading={isBanner ? "eager" : "lazy"}
        decoding={isBanner ? "sync" : "async"}
        crossorigin={isNetwork ? "anonymous" : undefined}
        referrerpolicy={isNetwork ? "no-referrer-when-downgrade" : undefined}
    />}
</div>
)}
