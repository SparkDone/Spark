---
import Pagination from "../../components/control/Pagination.astro";
import UniversalPostList from "../../components/UniversalPostList.astro";
import LayoutSwitcher from "../../components/LayoutSwitcher.astro";
import BannerCarousel from "../../components/ui/BannerCarousel.astro";
import { PAGE_SIZE } from "../../constants/constants";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import { getCategoryPageData, resetRequestCache } from "../../utils/unified-data-fetcher";
import { getCachedCategoryData } from "../../utils/category-preloader";
import { getFastCategoryPageData } from "../../utils/fast-category-loader";
import { getCategoryBanners, defaultBanner } from "../../data/banners";
import { getCategorySlug, getCategoryFromSlug } from "../../config/category-slugs";

// å¼ºåˆ¶å¯ç”¨é¢„æ¸²æŸ“ - ç”Ÿæˆé™æ€HTMLæ–‡ä»¶
export const prerender = true;

console.log('ğŸ—ï¸ åˆ†ç±»é¡µé¢ï¼šå¼ºåˆ¶é™æ€é¢„æ¸²æŸ“æ¨¡å¼');

// é™æ€è·¯å¾„ç”Ÿæˆå‡½æ•° - ç”Ÿæˆæ‰€æœ‰åˆ†ç±»çš„é™æ€é¡µé¢ï¼ˆåŒ…æ‹¬æ²¡æœ‰æ–‡ç« çš„åˆ†ç±»ï¼‰
export async function getStaticPaths() {

  try {
    console.log('ğŸ—ï¸ ç”Ÿäº§æ¨¡å¼ï¼šå¼€å§‹ç”Ÿæˆåˆ†ç±»é¡µé¢é™æ€è·¯å¾„...');

    // ä½¿ç”¨ getCategoryList è·å–æ‰€æœ‰åˆ†ç±»ï¼ˆåŒ…æ‹¬æ²¡æœ‰æ–‡ç« çš„åˆ†ç±»ï¼‰
    const { getCategoryList } = await import("../../utils/hybrid-content-utils");
    const allCategories = await getCategoryList();

    console.log(`ğŸ—ï¸ æ‰¾åˆ° ${allCategories.length} ä¸ªåˆ†ç±»ï¼ˆåŒ…æ‹¬æ²¡æœ‰æ–‡ç« çš„åˆ†ç±»ï¼‰:`, allCategories.map(c => `${c.name}(${c.count}ç¯‡)`));

    // ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆé™æ€è·¯å¾„ï¼Œä½¿ç”¨ç®€åŒ–çš„slug
    const paths = allCategories.map(categoryData => {
      const slug = getCategorySlug(categoryData.name);
      console.log(`ğŸ”— åˆ†ç±»è·¯å¾„æ˜ å°„: "${categoryData.name}" -> "${slug}" (${categoryData.count}ç¯‡æ–‡ç« )`);

      return {
        params: {
          category: slug // ä½¿ç”¨ç®€åŒ–çš„slug
        }
      };
    });

    console.log(`ğŸ—ï¸ å°†ç”Ÿæˆ ${paths.length} ä¸ªé™æ€åˆ†ç±»é¡µé¢ï¼ˆåŒ…æ‹¬ ${allCategories.filter(c => c.count === 0).length} ä¸ªç©ºåˆ†ç±»ï¼‰`);
    return paths;
  } catch (error) {
    console.error('âŒ ç”Ÿæˆåˆ†ç±»é™æ€è·¯å¾„å¤±è´¥:', error);
    return [];
  }
}

// è·å–åˆ†ç±»å‚æ•°å¹¶è½¬æ¢ä¸ºåˆ†ç±»å
const { category } = Astro.params;

// ä¸ºäº†æ­£ç¡®è§£æslugï¼Œæˆ‘ä»¬éœ€è¦è·å–æ‰€æœ‰åˆ†ç±»åˆ—è¡¨
let allCategories: string[] = [];
try {
  const { contentManager } = await import("../../lib/content-manager");
  const allPosts = await contentManager.getSortedPosts();
  allCategories = [...new Set(allPosts
    .map(post => post.data.category)
    .filter(Boolean)
  )];
} catch (error) {
  console.error('è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥:', error);
}

const categoryName = category ? getCategoryFromSlug(category, allCategories) : '';

// è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log('ğŸ” åˆ†ç±»å‚æ•°å¤„ç†:', {
    slugå‚æ•°: category,
    åˆ†ç±»å: categoryName,
    æ‰€æœ‰åˆ†ç±»: allCategories
  });
}

// ç”Ÿäº§æ¨¡å¼ä¸‹ç§»é™¤è°ƒè¯•æ—¥å¿—
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log('ğŸš€ğŸš€ğŸš€ CATEGORY.ASTRO åˆ†ç±»é¡µé¢å¼€å§‹æ‰§è¡Œ ğŸš€ğŸš€ğŸš€');
  console.log('ğŸš€ğŸš€ğŸš€ å½“å‰æ—¶é—´:', new Date().toISOString());
  console.log('ğŸš€ğŸš€ğŸš€ Astro.url:', Astro.url.pathname);
  console.log('ğŸš€ğŸš€ğŸš€ åˆ†ç±»å‚æ•°:', category);
}

if (!category || !categoryName) {
  console.log('âŒ åˆ†ç±»å‚æ•°ä¸ºç©ºæˆ–æ— æ•ˆ');
  return Astro.redirect('/404/');
}

// ä½¿ç”¨åˆ†ç±»åè·å–æ•°æ®
let categoryPageData;
let loadMethod = 'slug-mapped';

// è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log(`ğŸ” å¼€å§‹è·å–åˆ†ç±»æ•°æ®: ${categoryName} (slug: ${category})`);
}

const startTime = Date.now();
resetRequestCache();

try {
  categoryPageData = await getCategoryPageData(categoryName);
} catch (error) {
  console.error('âŒ è·å–åˆ†ç±»æ•°æ®å¤±è´¥:', error);
  // å¦‚æœè·å–æ•°æ®å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„åˆ†ç±»é¡µé¢æ•°æ®
  categoryPageData = {
    posts: [],
    categoryData: {
      name: categoryName,
      count: 0,
      url: `/categories/${category}/`
    },
    layoutType: 'list',
    categoryName: categoryName
  };
}

const loadTime = Date.now() - startTime;

if (import.meta.env.NODE_ENV !== 'production') {
  console.log(`âœ… åˆ†ç±»æ•°æ®è·å–å®Œæˆ: ${category} (${categoryPageData.posts.length}ç¯‡, ${loadTime}ms, æ–¹æ³•: ${loadMethod})`);
}

const {
  posts: categoryPosts,
  categoryData,
  layoutType,
  categoryName: originalCategoryName
} = categoryPageData;

// ä½¿ç”¨æˆ‘ä»¬è§£æçš„åˆ†ç±»åï¼Œè€Œä¸æ˜¯æ•°æ®è·å–å™¨è¿”å›çš„
const categoryDisplayName = categoryName;

// å¼‚æ­¥è·å–åˆ†ç±»Banneræ•°æ®å’Œå¼€å…³çŠ¶æ€
const categoryBanners = await getCategoryBanners(categoryName);
const showBanner = categoryBanners.length > 0;
const bannerImages = showBanner ? categoryBanners : [];

// è°ƒè¯•ä¿¡æ¯
if (import.meta.env.DEV) {
  console.log('ğŸ¨ åˆ†ç±»Bannerè°ƒè¯•:', {
    category,
    categoryBannersCount: categoryBanners.length,
    showBanner,
    bannerImagesCount: bannerImages.length
  });
}

// è¾“å‡ºåˆ†ç±»å¸ƒå±€ç±»å‹ç”¨äºè°ƒè¯•
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log('ğŸ” åˆ†ç±»é¡µé¢è°ƒè¯•ä¿¡æ¯:', {
    category,
    categoryData,
    layoutType,
    categoryDisplayName,
    hasData: !!categoryData,
    dataSource: categoryData ? 'Strapi' : 'Local'
  });
}

// è®¡ç®—åˆ†é¡µæ•°æ®
const totalPages = Math.ceil(categoryPosts.length / PAGE_SIZE);
const currentPage = 1;
const start = 0;
const end = PAGE_SIZE;
const data = categoryPosts.slice(start, end);

const page = {
  data,
  start,
  end: Math.min(end, categoryPosts.length),
  size: PAGE_SIZE,
  total: categoryPosts.length,
  currentPage,
  lastPage: totalPages,
  url: {
    current: `/categories/${category}/`,
    prev: undefined,
    next: totalPages > 1 ? `/categories/${category}/2/` : undefined,
  }
};

const len = page.data.length;
// è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
if (import.meta.env.DEV && !import.meta.env.PROD) {
  console.log('ğŸ” category.astro é¡µé¢æ•°æ®:', {
    dataLength: len,
    currentPage,
    totalPages,
    total: page.total,
    category
  });
}

// è®¾ç½®é¡µé¢æ ‡é¢˜ - SEO ä¼˜åŒ–æ ¼å¼
const title = categoryDisplayName;

// åˆ†ç±»é¡µé¢ç»“æ„åŒ–æ•°æ®
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `${categoryDisplayName} - æ–‡ç« åˆ†ç±»`,
  description: `æŸ¥çœ‹æ‰€æœ‰å…³äº ${categoryDisplayName} çš„æ–‡ç« `,
  url: Astro.url.href,
  mainEntity: {
    "@type": "ItemList",
    numberOfItems: categoryPosts.length,
    itemListElement: data.map((post, index) => ({
      "@type": "ListItem",
      position: index + 1,
      item: {
        "@type": "BlogPosting",
        headline: post.data.title,
        description: post.data.description || "",
        url: `${Astro.site?.href || "https://sparkdone.com"}posts/${post.slug}/`,
        datePublished: post.data.published.toISOString(),
        author: {
          "@type": "Person",
          name: typeof post.data.author === 'string' ? post.data.author : post.data.author?.name || "Admin"
        }
      }
    }))
  }
};
// decodedCategory å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å£°æ˜
---

<MainGridLayout title={title}>
  <!-- åˆ†ç±»é¡µé¢ç»“æ„åŒ–æ•°æ® -->
  <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

  <!-- é˜²æ­¢å¸ƒå±€è·³åŠ¨ï¼šåœ¨é¡µé¢åŠ è½½å‰è®¾ç½®æ­£ç¡®çš„å¸ƒå±€ -->
  <script is:inline slot="head">
    // ç«‹å³è®¾ç½®å¸ƒå±€ï¼Œé˜²æ­¢é—ªåŠ¨
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.querySelector('.universal-post-list');
      const switcher = document.querySelector('.layout-switcher');

      if (container && switcher) {
        const expectedLayout = switcher.getAttribute('data-default-layout') || 'grid';
        const currentLayout = container.getAttribute('data-layout');

        // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
        if (window.location.hostname === 'localhost' && !window.location.href.includes('dist')) {
          console.log('ğŸ” åˆ†ç±»é¡µé¢å¸ƒå±€æ£€æŸ¥:', {
            expectedLayout,
            currentLayout,
            switcherElement: !!switcher,
            containerElement: !!container
          });
        }

        // ç¡®ä¿å¸ƒå±€ä¸€è‡´
        if (currentLayout !== expectedLayout) {
          container.setAttribute('data-layout', expectedLayout);
          if (window.location.hostname === 'localhost') {
            console.log(`ğŸ”„ ä¿®æ­£å¸ƒå±€: ${currentLayout} -> ${expectedLayout}`);
          }
        }

        // ç¡®ä¿å®¹å™¨å¯è§
        container.style.opacity = '1';
      }
    });
  </script>

  <!-- ä¸º SwupA11yPlugin æ·»åŠ ä¸»æ ‡é¢˜ -->
  <h1 class="sr-only">åˆ†ç±»: {categoryDisplayName}</h1>
  
  {page.data.length > 0 ? (
    <>
      <!-- Bannerè½®æ’­ - æ¡ä»¶æ¸²æŸ“ -->
      {showBanner && (
        <div class="mb-8 onload-animation">
          <BannerCarousel
            images={bannerImages}
            autoPlay={true}
            interval={6000}
            showDots={false}
            showArrows={true}
            height="350px"
            className="w-full"
          />
        </div>
      )}

      <!-- å¸ƒå±€åˆ‡æ¢æ§ä»¶ -->
      <div class="flex justify-end items-center mb-6 onload-animation">
        <LayoutSwitcher defaultLayout={layoutType} targetSelector=".universal-post-list" />
      </div>

      <!-- ç»Ÿä¸€æ–‡ç« åˆ—è¡¨ - åªæ¸²æŸ“ä¸€æ¬¡ -->
      <UniversalPostList
        posts={page.data}
        defaultLayout={layoutType}
        class="onload-animation"
      />

      <!-- åˆ†é¡µ -->
      {totalPages > 1 && (
        <Pagination
          class="mx-auto onload-animation mt-8"
          page={page}
          style={`animation-delay: calc(var(--content-delay) + ${page.data.length * 50}ms)`}
        />
      )}
    </>
  ) : (
    <div class="text-center py-12">
      <h2 class="text-xl font-semibold mb-6 text-gray-900 dark:text-gray-100">è¯¥åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</h2>
      <a href="/" class="btn btn-primary">
        è¿”å›é¦–é¡µ
      </a>
    </div>
  )}
</MainGridLayout>
