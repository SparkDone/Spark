---
// é™æ€é¢„æ¸²æŸ“æœç´¢é¡µé¢
export const prerender = true;

import Layout from '../layouts/Layout.astro';
import MainGridLayout from '../layouts/MainGridLayout.astro';
import { Icon } from 'astro-icon/components';

// å®‰å…¨åœ°è·å–URLå‚æ•°
let query = '';
try {
  if (Astro.url && Astro.url.searchParams) {
    query = Astro.url.searchParams.get('q') || '';
  }
} catch (error) {
  console.warn('è·å–URLå‚æ•°å¤±è´¥:', error);
  query = '';
}

const title = query ? `æœç´¢ç»“æœ: ${query}` : 'æœç´¢';
---

<Layout title={title}>
  <MainGridLayout>
    <!-- ä¸º SwupA11yPlugin æ·»åŠ ä¸»æ ‡é¢˜ -->
    <h1 class="sr-only">{title}</h1>

    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
      <div class="card-base z-10 px-9 py-6 relative w-full">
        <!-- æœç´¢ç»“æœå®¹å™¨ -->
        <div id="search-results" class="space-y-4">

          <!-- åŠ è½½çŠ¶æ€ -->
          <div id="loading-state" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--primary)] mx-auto mb-4"></div>
            <p class="text-black/60 dark:text-white/60">æ­£åœ¨æœç´¢...</p>
          </div>
          
          <!-- æ— ç»“æœçŠ¶æ€ -->
          <div id="no-results" class="hidden text-center py-12">
            <Icon name="material-symbols:search-off" class="text-6xl text-black/20 dark:text-white/20 mb-4 mx-auto" />
            <p class="text-black/60 dark:text-white/60 mb-2">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>
            <p class="text-sm text-black/40 dark:text-white/40">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</p>
          </div>
          
          <!-- ç»“æœåˆ—è¡¨ -->
          <div id="results-list" class="space-y-4">
            <!-- åŠ¨æ€å¡«å……æœç´¢ç»“æœ -->
          </div>
        </div>

      </div>
    </div>
  </MainGridLayout>
</Layout>

<script>
  // æœç´¢åŠŸèƒ½
  let searchTimeout;
  let isSearching = false; // é˜²æ­¢é‡å¤æœç´¢
  let lastSearchQuery = ''; // è®°å½•ä¸Šæ¬¡æœç´¢çš„å…³é”®è¯
  let lastSearchTime = 0; // è®°å½•ä¸Šæ¬¡æœç´¢çš„æ—¶é—´

  // DOMå…ƒç´ å¼•ç”¨ - ä½¿ç”¨å‡½æ•°è·å–ä»¥ç¡®ä¿åœ¨Swupè½¬æ¢åæ­£ç¡®è·å–
  function getDOMElements() {
    return {
      searchResults: document.getElementById('search-results'),
      loadingState: document.getElementById('loading-state'),
      noResults: document.getElementById('no-results'),
      resultsList: document.getElementById('results-list')
    };
  }


  
  // æ‰§è¡Œæœç´¢
  async function performSearch(query) {
    const currentTime = Date.now();

    // é˜²é‡å¤æœç´¢æ£€æŸ¥
    if (isSearching) {
      console.log('â¸ï¸ æœç´¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
      return;
    }

    // å¦‚æœæ˜¯ç›¸åŒçš„æŸ¥è¯¢ä¸”æ—¶é—´é—´éš”å°äº1ç§’ï¼Œè·³è¿‡
    if (query === lastSearchQuery && (currentTime - lastSearchTime) < 1000) {
      console.log('â¸ï¸ ç›¸åŒæŸ¥è¯¢ä¸”æ—¶é—´é—´éš”è¿‡çŸ­ï¼Œè·³è¿‡é‡å¤æœç´¢');
      return;
    }

    console.log('ğŸ” å¼€å§‹æœç´¢:', query);
    isSearching = true;
    lastSearchQuery = query;
    lastSearchTime = currentTime;

    if (!query.trim()) {
      showInitialState();
      isSearching = false;
      return;
    }

    if (query.trim().length < 1) {
      console.log('âš ï¸ æœç´¢å…³é”®è¯ä¸ºç©º');
      isSearching = false;
      return;
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æœï¼Œå¦‚æœæœ‰åˆ™ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const { resultsList } = getDOMElements();
    const hasExistingResults = resultsList && resultsList.children.length > 0;

    if (!hasExistingResults) {
      showLoadingState();
    }

    // å°è¯•ä½¿ç”¨Pagefindæœç´¢ï¼ˆç”Ÿäº§ç¯å¢ƒä¼˜å…ˆï¼‰
    let searchResults = [];
    let searchMethod = 'unknown';

    try {
      // æ–¹æ³•1ï¼šå°è¯•Pagefindæœç´¢
      if (typeof window !== 'undefined' && window.pagefind && typeof window.pagefind.search === 'function') {
        console.log('ğŸ” ä½¿ç”¨Pagefindæœç´¢:', query);
        searchMethod = 'pagefind';

        const pagefindResponse = await window.pagefind.search(query, {
          excerpt_length: 100,
          fuzzy: true,
          partial: true
        });

        if (pagefindResponse && pagefindResponse.results && pagefindResponse.results.length > 0) {
          if (import.meta.env.DEV) {
            console.log('âœ… Pagefindæ‰¾åˆ°ç»“æœ:', pagefindResponse.results.length, 'ä¸ª');
          }
          const pagefindResults = await Promise.all(
            pagefindResponse.results.slice(0, 50).map(item => item.data())
          );

          // è½¬æ¢Pagefindç»“æœæ ¼å¼
          searchResults = pagefindResults.map(item => ({
            title: item.meta?.title || 'æ— æ ‡é¢˜',
            url: item.url,
            excerpt: item.excerpt || '',
            description: item.meta?.description || '',
            slug: item.url.replace('/posts/', '').replace('/', ''),
            category: '',
            tags: [],
            published: null
          }));
        }
      }

      // æ–¹æ³•2ï¼šå¦‚æœPagefindå¤±è´¥æˆ–æ— ç»“æœï¼Œä½¿ç”¨APIæœç´¢
      if (searchResults.length === 0) {
        console.log('ğŸ” Pagefindæ— ç»“æœï¼Œå°è¯•APIæœç´¢:', query);
        searchMethod = 'api';

        const apiUrl = `/api/search/?q=${encodeURIComponent(query)}&limit=50`;
        console.log('ğŸ“¡ å‘é€æœç´¢è¯·æ±‚:', apiUrl);

        const response = await fetch(apiUrl);
        console.log('ğŸ“Š æœç´¢å“åº”çŠ¶æ€:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('ğŸ“‹ æœç´¢å“åº”æ•°æ®:', data);

          if (data.success && data.data && data.data.length > 0) {
            console.log('âœ… APIæ‰¾åˆ°æœç´¢ç»“æœ:', data.data.length, 'ä¸ª');
            searchResults = data.data;
          }
        } else {
          console.warn('âš ï¸ APIæœç´¢è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
        }
      }

      // æ˜¾ç¤ºç»“æœ
      if (searchResults.length > 0) {
        if (import.meta.env.DEV) {
          console.log(`âœ… æœ€ç»ˆæ˜¾ç¤º ${searchResults.length} ä¸ªæœç´¢ç»“æœ (æ–¹æ³•: ${searchMethod})`);
        }
        showResults(searchResults, query);
      } else {
        if (import.meta.env.DEV) {
          console.log('âŒ æ‰€æœ‰æœç´¢æ–¹æ³•éƒ½æœªæ‰¾åˆ°ç»“æœ');
        }
        showNoResults();
      }

    } catch (error) {
      console.error('âŒ æœç´¢é”™è¯¯:', error);
      showNoResults();
    } finally {
      // æœç´¢å®Œæˆï¼Œé‡ç½®çŠ¶æ€
      isSearching = false;
    }
  }
  
  // æ˜¾ç¤ºçŠ¶æ€å‡½æ•° - åŠ¨æ€è·å–DOMå…ƒç´ ï¼Œå‡å°‘é—ªçƒ
  function showInitialState() {
    const { loadingState, noResults, resultsList } = getDOMElements();
    if (import.meta.env.DEV) {
      console.log('ğŸ“ æ˜¾ç¤ºåˆå§‹çŠ¶æ€');
    }
    if (loadingState) loadingState.classList.add('hidden');
    if (noResults) noResults.classList.add('hidden');
    if (resultsList) resultsList.classList.add('hidden');
  }

  function showLoadingState() {
    const { loadingState, noResults, resultsList } = getDOMElements();
    if (import.meta.env.DEV) {
      console.log('â³ æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
    }
    // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…å¿«é€Ÿæœç´¢æ—¶çš„é—ªçƒ
    setTimeout(() => {
      if (isSearching) { // åªæœ‰åœ¨ä»åœ¨æœç´¢æ—¶æ‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (loadingState) loadingState.classList.remove('hidden');
        if (noResults) noResults.classList.add('hidden');
        if (resultsList) resultsList.classList.add('hidden');
      }
    }, 100);
  }

  function showNoResults() {
    const { loadingState, noResults, resultsList } = getDOMElements();
    if (import.meta.env.DEV) {
      console.log('âŒ æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€');
    }
    if (loadingState) loadingState.classList.add('hidden');
    if (noResults) noResults.classList.remove('hidden');
    if (resultsList) resultsList.classList.add('hidden');
  }
  
  function showResults(results, query) {
    if (import.meta.env.DEV) {
      console.log('ğŸ¨ æ¸²æŸ“æœç´¢ç»“æœ:', results.length, 'ä¸ª');
    }

    const { loadingState, noResults, resultsList } = getDOMElements();

    // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!resultsList) {
      console.error('âŒ æ— æ³•æ‰¾åˆ°ç»“æœåˆ—è¡¨å…ƒç´ ');
      return;
    }

    loadingState?.classList.add('hidden');
    noResults?.classList.add('hidden');
    resultsList.classList.remove('hidden');

    try {
      // æ¸²æŸ“ç»“æœ
      const resultsHtml = results.map((item, index) => {
        // å®‰å…¨åœ°è·å–å„ä¸ªå­—æ®µ
        const title = item.title || `ç»“æœ ${index + 1}`;
        const url = item.url || '#';
        const excerpt = item.excerpt || 'æš‚æ— æè¿°';
        const category = item.category || 'æœªåˆ†ç±»';
        const publishedDate = item.published ?
          new Date(item.published).toLocaleDateString() : '';

        return `
          <article class="bg-white/50 dark:bg-black/20 rounded-lg p-6 border border-black/5 dark:border-white/5 hover:border-[var(--primary)]/20 transition-all hover:shadow-lg">
            <h3 class="text-lg font-semibold mb-2">
              <a href="${url}" class="text-black/90 dark:text-white/90 hover:text-[var(--primary)] transition-colors">
                ${title}
              </a>
            </h3>
            <div class="text-sm text-black/60 dark:text-white/60 mb-3 leading-relaxed">
              ${excerpt}
            </div>
            <div class="flex items-center justify-between text-xs text-black/40 dark:text-white/40">
              <span>${category}</span>
              <span>${publishedDate}</span>
            </div>
          </article>
        `;
      }).join('');

      // æ·»åŠ ç»“æœç»Ÿè®¡
      const statsHtml = `
        <div class="text-center py-4 mb-6">
          <p class="text-sm text-black/60 dark:text-white/60">
            æ‰¾åˆ° <span class="font-semibold text-[var(--primary)]">${results.length}</span> ä¸ªç›¸å…³ç»“æœ
          </p>
        </div>
      `;

      resultsList.innerHTML = statsHtml + resultsHtml;
      if (import.meta.env.DEV) {
        console.log('âœ… æœç´¢ç»“æœæ¸²æŸ“å®Œæˆ');
      }

    } catch (error) {
      console.error('âŒ æ¸²æŸ“æœç´¢ç»“æœæ—¶å‡ºé”™:', error);
      showNoResults();
    }
  }
  
  // æ£€æŸ¥DOMæ˜¯å¦å‡†å¤‡å¥½
  function isDOMReady() {
    const { searchResults, loadingState, noResults, resultsList } = getDOMElements();
    const isReady = !!(searchResults && loadingState && noResults && resultsList);
    if (import.meta.env.DEV) {
      console.log('ğŸ” DOMå‡†å¤‡çŠ¶æ€:', {
        searchResults: !!searchResults,
        loadingState: !!loadingState,
        noResults: !!noResults,
        resultsList: !!resultsList,
        isReady
      });
    }
    return isReady;
  }

  // ä»URLå‚æ•°æ‰§è¡Œæœç´¢çš„é€šç”¨å‡½æ•°
  function searchFromUrl() {
    try {
      const urlQuery = new URLSearchParams(window.location.search).get('q');
      if (import.meta.env.DEV) {
        console.log('ğŸ” æ£€æŸ¥URLå‚æ•°:', {
          url: window.location.href,
          search: window.location.search,
          query: urlQuery,
          pathname: window.location.pathname
        });
      }

      // æ£€æŸ¥DOMæ˜¯å¦å‡†å¤‡å¥½
      if (!isDOMReady()) {
        if (import.meta.env.DEV) {
          console.log('â³ DOMæœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿæ‰§è¡Œæœç´¢');
        }
        setTimeout(() => {
          if (isDOMReady()) {
            searchFromUrl();
          } else {
            if (import.meta.env.DEV) {
              console.error('âŒ DOMå…ƒç´ ä»æœªå‡†å¤‡å¥½');
            }
          }
        }, 100);
        return;
      }

      if (urlQuery) {
        if (import.meta.env.DEV) {
          console.log('ğŸ” ä»URLå‚æ•°æ‰§è¡Œæœç´¢:', urlQuery);
        }
        performSearch(urlQuery);
      } else {
        if (import.meta.env.DEV) {
          console.log('ğŸ“ URLä¸­æ²¡æœ‰æœç´¢å‚æ•°ï¼Œæ˜¾ç¤ºåˆå§‹çŠ¶æ€');
        }
        showInitialState();
      }
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('è·å–URLå‚æ•°å¤±è´¥:', error);
      }
      showInitialState();
    }
  }



  // Pagefindåˆå§‹åŒ–
  async function initializePagefind() {
    try {
      if (typeof window !== 'undefined' && !window.pagefind) {
        if (import.meta.env.DEV) {
          console.log('ğŸ” å°è¯•åˆå§‹åŒ–Pagefind...');
        }

        // ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œé¿å…æ„å»ºæ—¶çš„è·¯å¾„è§£æé—®é¢˜
        const pagefindModule = await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = '/pagefind/pagefind.js';
          script.onload = () => {
            if (window.pagefind) {
              resolve(window.pagefind);
            } else {
              reject(new Error('Pagefindæœªæ­£ç¡®åŠ è½½'));
            }
          };
          script.onerror = () => reject(new Error('Pagefindè„šæœ¬åŠ è½½å¤±è´¥'));
          document.head.appendChild(script);
        });

        await pagefindModule.options({
          excerptLength: 100,
          highlightParam: 'mark'
        });

        if (import.meta.env.DEV) {
          console.log('âœ… Pagefindåˆå§‹åŒ–æˆåŠŸ');
        }
      }
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('âš ï¸ Pagefindåˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨APIæœç´¢:', error);
      }
      window.pagefind = null;
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', async () => {
    if (import.meta.env.DEV) {
      console.log('ğŸ“„ æœç´¢é¡µé¢DOMContentLoaded');
    }

    // å…ˆåˆå§‹åŒ–Pagefindï¼Œç„¶åæ‰§è¡Œæœç´¢
    await initializePagefind();
    searchFromUrl();
  });

  // ç®€åŒ–çš„æµè§ˆå™¨å†å²è®°å½•ç›‘å¬
  window.addEventListener('popstate', (event) => {
    if (window.location.pathname === '/search/') {
      console.log('ğŸ”„ æµè§ˆå™¨å†å²è®°å½•å˜åŒ–ï¼Œé‡æ–°æ‰§è¡Œæœç´¢');
      setTimeout(() => {
        searchFromUrl();
      }, 100);
    }
  });

  // ç›‘å¬Swupé¡µé¢è½¬æ¢äº‹ä»¶
  function setupSwupListeners() {
    if (window.swup && window.swup.hooks) {
      console.log('ğŸ”„ è®¾ç½®Swupäº‹ä»¶ç›‘å¬å™¨');

      // ç®€åŒ–çš„é¡µé¢è½¬æ¢ç›‘å¬
      window.swup.hooks.on('page:view', () => {
        if (window.location.pathname === '/search/') {
          console.log('ğŸ”„ Swupé¡µé¢è½¬æ¢å®Œæˆï¼Œæ‰§è¡Œæœç´¢');
          setTimeout(() => {
            searchFromUrl();
          }, 100);
        }
      });
    }
  }

  // å¦‚æœSwupå·²ç»åŠ è½½ï¼Œç«‹å³è®¾ç½®ç›‘å¬å™¨
  if (window.swup) {
    setupSwupListeners();
  } else {
    // å¦åˆ™ç­‰å¾…SwupåŠ è½½å®Œæˆ
    document.addEventListener('swup:enable', setupSwupListeners);
  }

  // ç®€åŒ–çš„å®‰å…¨æªæ–½ï¼šåªåœ¨å¿…è¦æ—¶æ£€æŸ¥
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && window.location.pathname === '/search/' && !isSearching) {
      console.log('ğŸ”„ é¡µé¢å˜ä¸ºå¯è§ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æœç´¢');
      // æ£€æŸ¥æ˜¯å¦æœ‰æœç´¢ç»“æœï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°æœç´¢
      const { resultsList } = getDOMElements();
      const hasResults = resultsList && resultsList.children.length > 0;
      const urlQuery = new URLSearchParams(window.location.search).get('q');

      if (urlQuery && !hasResults) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°æœ‰æœç´¢å‚æ•°ä½†æ— ç»“æœï¼Œé‡æ–°æ‰§è¡Œæœç´¢');
        setTimeout(() => {
          searchFromUrl();
        }, 200);
      }
    }
  });


</script>
