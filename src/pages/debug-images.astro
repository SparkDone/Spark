---
// å›¾ç‰‡è°ƒè¯•é¡µé¢
import { getPublishedArticles } from '../lib/strapi';
import { adaptImageUrl, imageConfig } from '../utils/image-adapter';

let articles = [];
let error = null;

try {
  const response = await getPublishedArticles();
  articles = response.data || [];
} catch (e) {
  error = e.message;
  console.error('è·å–æ–‡ç« å¤±è´¥:', e);
}

// æµ‹è¯•å›¾ç‰‡URL
const testImageUrls = [
  '/uploads/test.jpg',
  'https://api.sparkdone.com/uploads/test.jpg',
  '/images/strapi/test.jpg'
];
---

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡è°ƒè¯•é¡µé¢</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    .image-test { margin: 10px 0; }
    .image-test img { max-width: 200px; height: auto; border: 1px solid #ccc; }
    .error { color: red; }
    .success { color: green; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ å›¾ç‰‡è°ƒè¯•é¡µé¢</h1>

  <div class="debug-section">
    <h2>ğŸ“‹ ç¯å¢ƒé…ç½®</h2>
    <pre>{JSON.stringify({
      STRAPI_URL: import.meta.env.STRAPI_URL,
      STRAPI_PUBLIC_URL: import.meta.env.STRAPI_PUBLIC_URL,
      imageConfig: imageConfig
    }, null, 2)}</pre>
  </div>

  <div class="debug-section">
    <h2>ğŸ”— APIè¿æ¥çŠ¶æ€</h2>
    {error ? (
      <p class="error">âŒ APIè¿æ¥å¤±è´¥: {error}</p>
    ) : (
      <p class="success">âœ… APIè¿æ¥æˆåŠŸï¼Œè·å–åˆ° {articles.length} ç¯‡æ–‡ç« </p>
    )}

    <h3>ğŸ” åŸå§‹APIå“åº”æµ‹è¯•</h3>
    <p>è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®ä»¥ä¸‹URLæŸ¥çœ‹åŸå§‹APIå“åº”ï¼š</p>
    <a href={`${import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/api/articles?populate[0]=image&populate[1]=category&populate[2]=tags&populate[3]=author.avatar&filters[draft][$eq]=false&sort=published:desc`} target="_blank" style="word-break: break-all;">
      {import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/api/articles?populate[0]=image&populate[1]=category&populate[2]=tags&populate[3]=author.avatar&filters[draft][$eq]=false&sort=published:desc
    </a>
    <p><small>æ³¨æ„ï¼šæ‚¨éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  Authorization: Bearer YOUR_TOKEN</small></p>
  </div>

  <div class="debug-section">
    <h2>ğŸ§ª å›¾ç‰‡URLæµ‹è¯•</h2>
    <div class="image-test">
      <h3>æµ‹è¯•çœŸå®çš„Strapiä¸Šä¼ å›¾ç‰‡</h3>
      <p>è¯·æ‰‹åŠ¨æµ‹è¯•ä»¥ä¸‹URLæ˜¯å¦å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®ï¼š</p>
      <ul>
        <li><a href={`${import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/uploads/`} target="_blank">{import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/uploads/</a></li>
        <li><a href={`${import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/api/upload/files`} target="_blank">{import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL}/api/upload/files</a></li>
      </ul>
    </div>

    {testImageUrls.map(url => (
      <div class="image-test">
        <p><strong>åŸå§‹URL:</strong> {url}</p>
        <p><strong>è½¬æ¢å:</strong> {adaptImageUrl(url)}</p>
        <img src={adaptImageUrl(url)} alt="æµ‹è¯•å›¾ç‰‡" onerror="this.style.border='2px solid red'; this.alt='âŒ åŠ è½½å¤±è´¥';" onload="this.style.border='2px solid green';" />
      </div>
    ))}
  </div>

  <div class="debug-section">
    <h2>ğŸ“° æ–‡ç« å›¾ç‰‡</h2>
    {articles.slice(0, 3).map(article => (
      <div class="image-test">
        <h3>{article.title}</h3>
        <p><strong>æ–‡ç« ID:</strong> {article.id}</p>

        <!-- è°ƒè¯•ï¼šæ˜¾ç¤ºå®Œæ•´çš„æ–‡ç« æ•°æ®ç»“æ„ -->
        <details>
          <summary>ğŸ” æŸ¥çœ‹å®Œæ•´æ–‡ç« æ•°æ®</summary>
          <pre>{JSON.stringify(article, null, 2)}</pre>
        </details>

        <!-- æ£€æŸ¥å„ç§å¯èƒ½çš„å›¾ç‰‡å­—æ®µå -->
        <div style="margin: 10px 0;">
          <p><strong>å›¾ç‰‡å­—æ®µè¯¦ç»†æ£€æŸ¥:</strong></p>
          <ul>
            <li>article.image: {article.image ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>
            {article.image && (
              <li style="margin-left: 20px;">
                ç±»å‹: {Array.isArray(article.image) ? `æ•°ç»„ï¼Œé•¿åº¦: ${article.image.length}` : typeof article.image}
              </li>
            )}
            {article.image && Array.isArray(article.image) && article.image.length > 0 && (
              <li style="margin-left: 20px;">
                ç¬¬ä¸€ä¸ªå…ƒç´ : {JSON.stringify(article.image[0], null, 2)}
              </li>
            )}
            {article.image && !Array.isArray(article.image) && (
              <li style="margin-left: 20px;">
                å¯¹è±¡å†…å®¹: {JSON.stringify(article.image, null, 2)}
              </li>
            )}
            <li>article.cover: {article.cover ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>
            <li>article.featured_image: {article.featured_image ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>
            <li>article.thumbnail: {article.thumbnail ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>
          </ul>
        </div>

        {/* å¤„ç†æ•°ç»„ç±»å‹çš„imageå­—æ®µ */}
        {article.image && Array.isArray(article.image) && article.image.length > 0 ? (
          <div>
            <p><strong>å›¾ç‰‡ç±»å‹:</strong> æ•°ç»„ï¼Œç¬¬ä¸€å¼ å›¾ç‰‡</p>
            <p><strong>åŸå§‹å›¾ç‰‡URL:</strong> {article.image[0].url}</p>
            <p><strong>è½¬æ¢åURL:</strong> {adaptImageUrl(article.image[0].url)}</p>
            <img
              src={adaptImageUrl(article.image[0].url)}
              alt={article.title}
              onerror="this.style.border='2px solid red'; this.alt='âŒ åŠ è½½å¤±è´¥';"
              onload="this.style.border='2px solid green';"
            />
          </div>
        ) : /* å¤„ç†å¯¹è±¡ç±»å‹çš„imageå­—æ®µ */
        article.image && !Array.isArray(article.image) && article.image.url ? (
          <div>
            <p><strong>å›¾ç‰‡ç±»å‹:</strong> å•ä¸ªå¯¹è±¡</p>
            <p><strong>åŸå§‹å›¾ç‰‡URL:</strong> {article.image.url}</p>
            <p><strong>è½¬æ¢åURL:</strong> {adaptImageUrl(article.image.url)}</p>
            <img
              src={adaptImageUrl(article.image.url)}
              alt={article.title}
              onerror="this.style.border='2px solid red'; this.alt='âŒ åŠ è½½å¤±è´¥';"
              onload="this.style.border='2px solid green';"
            />
          </div>
        ) : article.cover ? (
          <div>
            <p><strong>å°é¢å›¾ç‰‡URL:</strong> {article.cover.url}</p>
            <p><strong>è½¬æ¢åURL:</strong> {adaptImageUrl(article.cover.url)}</p>
            <img
              src={adaptImageUrl(article.cover.url)}
              alt={article.title}
              onerror="this.style.border='2px solid red'; this.alt='âŒ åŠ è½½å¤±è´¥';"
              onload="this.style.border='2px solid green';"
            />
          </div>
        ) : (
          <p>âŒ è¯¥æ–‡ç« æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡å­—æ®µ</p>
        )}
      </div>
    ))}
  </div>

  <div class="debug-section">
    <h2>ğŸ” æ‰‹åŠ¨æµ‹è¯•</h2>
    <p>è¯·åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networkæ ‡ç­¾é¡µä¸­æŸ¥çœ‹å›¾ç‰‡è¯·æ±‚çš„çŠ¶æ€ã€‚</p>
    <p>å¸¸è§é—®é¢˜ï¼š</p>
    <ul>
      <li><strong>404é”™è¯¯:</strong> å›¾ç‰‡è·¯å¾„ä¸æ­£ç¡®</li>
      <li><strong>403é”™è¯¯:</strong> éœ€è¦è®¤è¯æˆ–æƒé™ä¸è¶³</li>
      <li><strong>CORSé”™è¯¯:</strong> è·¨åŸŸè®¿é—®è¢«é˜»æ­¢</li>
      <li><strong>è¿æ¥è¶…æ—¶:</strong> æœåŠ¡å™¨å“åº”æ…¢æˆ–ä¸å¯è¾¾</li>
    </ul>
  </div>

  <script>
    // å®¢æˆ·ç«¯è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ–¼ï¸ å›¾ç‰‡è°ƒè¯•ä¿¡æ¯');
    console.log('å½“å‰é¡µé¢URL:', window.location.href);
    console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent);
    
    // ç›‘å¬å›¾ç‰‡åŠ è½½é”™è¯¯
    document.addEventListener('error', function(e) {
      if (e.target.tagName === 'IMG') {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', e.target.src);
      }
    }, true);
  </script>
</body>
</html>
