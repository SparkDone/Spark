---
// æ··åˆæ¨¡å¼ï¼šé¦–é¡µé™æ€é¢„æ¸²æŸ“
export const prerender = true;

import UniversalPostList from "../components/UniversalPostList.astro";
import LayoutSwitcher from "../components/LayoutSwitcher.astro";
import BannerCarousel from "../components/ui/BannerCarousel.astro";
import { getHomeBannersFromStrapi } from "../lib/banner-adapter";



import { PAGE_SIZE } from "../constants/constants";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { getIndexPageData, resetRequestCache } from "../utils/unified-data-fetcher";
import { contentManager } from "../lib/content-manager";
import { getLayoutConfig, getSiteConfig } from "../lib/config-integration";
import { preloadPopularCategories } from "../utils/category-preloader";
import { preheatAllCategories } from "../utils/fast-category-loader";
// import { getHomeBanners } from "../data/banners"; // ä¸å†éœ€è¦ï¼Œä½¿ç”¨åŠ¨æ€ç»„ä»¶

// ğŸš€ ä¼˜åŒ–ï¼šåªè·å–é¦–é¡µéœ€è¦çš„æ•°æ®
resetRequestCache();

// å¹¶è¡Œè·å–æ•°æ®ä»¥æé«˜æ€§èƒ½
const [indexPageData, firstPagePosts, bannerImages, layoutConfig] = await Promise.all([
  getIndexPageData(),
  // åªè·å–é¦–é¡µéœ€è¦çš„æ–‡ç« æ•°é‡ï¼Œå‡å°‘æ•°æ®ä¼ è¾“
  contentManager.getPaginatedPosts(1, PAGE_SIZE),
  // è·å–é¦–é¡µBanneræ•°æ®
  getHomeBannersFromStrapi(),
  // è·å–æ•´åˆåçš„å¸ƒå±€é…ç½®
  getLayoutConfig()
]);

// å¼‚æ­¥é¢„çƒ­æ‰€æœ‰åˆ†ç±»ï¼ˆä¸é˜»å¡é¡µé¢æ¸²æŸ“ï¼‰
Promise.all([
  preloadPopularCategories().catch(error => {
    console.warn('âš ï¸ é¢„åŠ è½½çƒ­é—¨åˆ†ç±»å¤±è´¥:', error);
  }),
  preheatAllCategories().catch(error => {
    console.warn('âš ï¸ é¢„çƒ­æ‰€æœ‰åˆ†ç±»å¤±è´¥:', error);
  })
]);

const { indexSettings } = indexPageData;
const { posts: data, total: totalPosts } = firstPagePosts;

// è®¡ç®—åˆ†é¡µæ•°æ®
const totalPages = Math.ceil(totalPosts / PAGE_SIZE);
const currentPage = 1;
const defaultLayout = layoutConfig.defaultHomepageLayout;

// Banneræ˜¾ç¤ºé€»è¾‘
const showBanner = bannerImages && bannerImages.length > 0;

if (import.meta.env.DEV) {
  console.log('ğŸ¨ é¦–é¡µè°ƒè¯•ä¿¡æ¯:', {
    indexSettings,
    defaultLayout,
    hasIndexSettings: !!indexSettings,
    settingsLayout: indexSettings?.default_homepage_layout
  });
}

// é¦–é¡µä¸è®¾ç½®ç‰¹å®šæ ‡é¢˜ï¼Œè®© Layout ä½¿ç”¨é»˜è®¤çš„ "ç½‘ç«™åç§° - ç½‘ç«™å‰¯æ ‡é¢˜" æ ¼å¼
const title = undefined;

// è·å–æ•´åˆåçš„ç«™ç‚¹é…ç½®ç”¨äºç»“æ„åŒ–æ•°æ®
const siteConfigData = await getSiteConfig();
const strapiSiteTitle = siteConfigData.title;
const strapiSiteDescription = siteConfigData.description || siteConfigData.subtitle;

// é¦–é¡µç»“æ„åŒ–æ•°æ®
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: strapiSiteTitle,
  description: strapiSiteDescription,
  url: Astro.site?.href || "https://sparkdone.com",
  potentialAction: {
    "@type": "SearchAction",
    target: {
      "@type": "EntryPoint",
      urlTemplate: `${Astro.site?.href || "https://sparkdone.com"}search?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  },
  publisher: {
    "@type": "Organization",
    name: strapiSiteTitle,
    url: Astro.site?.href || "https://sparkdone.com"
  }
};
---

<MainGridLayout title={title}>
    <!-- é¦–é¡µç»“æ„åŒ–æ•°æ® -->
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

    <!-- ä¸º SwupA11yPlugin æ·»åŠ ä¸»æ ‡é¢˜ -->
    <h1 class="sr-only">é¦–é¡µ</h1>



    <!-- Bannerè½®æ’­ - æ¡ä»¶æ¸²æŸ“ -->
    {showBanner && (
        <div class="mb-8 onload-animation">
            <BannerCarousel
                images={bannerImages}
                autoPlay={true}
                interval={5000}
                showDots={false}
                showArrows={true}
                height="400px"
                className="w-full"
            />
        </div>
    )}

    <!-- å¸ƒå±€åˆ‡æ¢æ§ä»¶ -->
    <div class="flex justify-end items-center mb-6 onload-animation">
        <LayoutSwitcher defaultLayout={defaultLayout} targetSelector=".universal-post-list" />
    </div>

    <!-- ç»Ÿä¸€æ–‡ç« åˆ—è¡¨ - åªæ¸²æŸ“ä¸€æ¬¡ -->
    <UniversalPostList
        posts={data}
        defaultLayout={defaultLayout}
        class="onload-animation"
    />
</MainGridLayout>

<!-- ä¼˜åŒ–ï¼šå…³é”®è„šæœ¬ä¼˜å…ˆåŠ è½½ -->
<script>
    // ä½¿ç”¨æ›´ç¨³å®šçš„æ¨¡å—åŠ è½½æ–¹å¼ï¼Œé¿å…æ„å»ºæ—¶çš„è·¯å¾„é—®é¢˜
    async function loadCriticalModules() {
        try {
            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥ï¼Œè®©Astroå¤„ç†è·¯å¾„è§£æ
            const modulePromises = [];

            // åŠ¨æ€å¯¼å…¥æ¨¡å—ç®¡ç†å™¨
            try {
                const moduleManagerModule = await import('../scripts/module-manager.js');
                if (moduleManagerModule) {
                    modulePromises.push(Promise.resolve(moduleManagerModule));
                }
            } catch (e) {
                console.warn('âš ï¸ æ¨¡å—ç®¡ç†å™¨åŠ è½½å¤±è´¥ï¼Œè·³è¿‡');
            }

            // åŠ¨æ€å¯¼å…¥æ‡’åŠ è½½å·¥å…·
            try {
                const lazyLoaderModule = await import('../utils/lazy-loader.ts');
                if (lazyLoaderModule && lazyLoaderModule.setupImageLazyLoading) {
                    lazyLoaderModule.setupImageLazyLoading();
                    if (import.meta.env.DEV) {
                        console.log('âœ… å›¾ç‰‡æ‡’åŠ è½½å·²åˆå§‹åŒ–');
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ æ‡’åŠ è½½å·¥å…·åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                // å¤‡ç”¨æ–¹æ¡ˆï¼šåŸºæœ¬çš„å›¾ç‰‡æ‡’åŠ è½½
                setupBasicImageLazyLoading();
            }

            if (import.meta.env.DEV) {
                console.log('ğŸš€ å…³é”®åŠŸèƒ½åŠ è½½å®Œæˆ');
            }
        } catch (error) {
            console.error('âŒ å…³é”®åŠŸèƒ½åŠ è½½å¤±è´¥:', error);
            // ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
            setupBasicImageLazyLoading();
        }
    }

    // å¤‡ç”¨çš„åŸºæœ¬å›¾ç‰‡æ‡’åŠ è½½
    function setupBasicImageLazyLoading() {
        if (typeof window !== 'undefined' && 'IntersectionObserver' in window) {
            const images = document.querySelectorAll('img[loading="lazy"]');
            if (images.length > 0) {
                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                            }
                            imageObserver.unobserve(img);
                        }
                    });
                });

                images.forEach(img => imageObserver.observe(img));

                if (import.meta.env.DEV) {
                    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡æ‡’åŠ è½½æ–¹æ¡ˆ');
                }
            }
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCriticalModules);
    } else {
        loadCriticalModules();
    }
</script>


