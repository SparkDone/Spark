---
/**
 * æœç´¢åŠŸèƒ½æ·±åº¦è¯Šæ–­
 */

import { getSortedPosts } from "../utils/strapi-content-utils";
import { searchArticles } from "../lib/strapi";

const posts = await getSortedPosts();
const testKeywords = ["11", "é“¶ç¿¼æ€æ‰‹", "MIT", "æŠ€æœ¯"];

// æµ‹è¯•æ¯ä¸ªå…³é”®è¯
const testResults = [];

for (const keyword of testKeywords) {
  const result = {
    keyword,
    strapiResults: [],
    localResults: [],
    strapiError: null,
    localError: null
  };

  // æµ‹è¯•Strapiæœç´¢
  try {
    const strapiResponse = await searchArticles(keyword);
    result.strapiResults = strapiResponse.data || [];
  } catch (error) {
    result.strapiError = error.message;
  }

  // æµ‹è¯•æœ¬åœ°æœç´¢
  try {
    const searchTerm = keyword.toLowerCase();
    const matchedPosts = posts.filter(post => {
      const title = post.data.title?.toLowerCase() || '';
      const description = post.data.description?.toLowerCase() || '';
      const content = post.body?.toLowerCase() || '';
      const tags = post.data.tags?.join(' ').toLowerCase() || '';
      const category = post.data.category?.toLowerCase() || '';

      return title.includes(searchTerm) ||
             description.includes(searchTerm) ||
             content.includes(searchTerm) ||
             tags.includes(searchTerm) ||
             category.includes(searchTerm);
    });

    result.localResults = matchedPosts.map(post => ({
      title: post.data.title,
      slug: post.slug,
      contentLength: post.body?.length || 0,
      hasContent: !!post.body,
      contentPreview: post.body?.substring(0, 200) || 'æ— å†…å®¹'
    }));
  } catch (error) {
    result.localError = error.message;
  }

  testResults.push(result);
}

// åˆ†ææ–‡ç« å†…å®¹
const contentAnalysis = posts.slice(0, 3).map(post => ({
  title: post.data.title,
  slug: post.slug,
  hasBody: !!post.body,
  bodyLength: post.body?.length || 0,
  bodyPreview: post.body?.substring(0, 500) || 'æ— å†…å®¹',
  contains11: post.body?.toLowerCase().includes('11') || false,
  containsMIT: post.body?.toLowerCase().includes('mit') || false,
  containsChinese: /[\u4e00-\u9fa5]/.test(post.body || '') || false
}));
---

<html>
<head>
    <meta charset="UTF-8">
    <title>æœç´¢åŠŸèƒ½æ·±åº¦è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #060; }
        .warning { background: #fff3cd; color: #856404; }
        .code { background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        .result { margin: 10px 0; padding: 10px; border-left: 3px solid #ccc; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ” æœç´¢åŠŸèƒ½æ·±åº¦è¯Šæ–­</h1>

    <div class="section">
        <h2>ğŸ“Š åŸºç¡€ç»Ÿè®¡</h2>
        <table>
            <tr><th>é¡¹ç›®</th><th>æ•°å€¼</th></tr>
            <tr><td>æ€»æ–‡ç« æ•°</td><td>{posts.length}</td></tr>
            <tr><td>æœ‰å†…å®¹çš„æ–‡ç« æ•°</td><td>{posts.filter(p => p.body).length}</td></tr>
            <tr><td>æ— å†…å®¹çš„æ–‡ç« æ•°</td><td>{posts.filter(p => !p.body).length}</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>ğŸ“ æ–‡ç« å†…å®¹åˆ†æ</h2>
        {contentAnalysis.map(analysis => (
            <div class="result">
                <h3>{analysis.title}</h3>
                <table>
                    <tr><td>Slug</td><td>{analysis.slug}</td></tr>
                    <tr><td>æœ‰å†…å®¹</td><td class={analysis.hasBody ? 'success' : 'error'}>{analysis.hasBody ? 'âœ… æ˜¯' : 'âŒ å¦'}</td></tr>
                    <tr><td>å†…å®¹é•¿åº¦</td><td>{analysis.bodyLength} å­—ç¬¦</td></tr>
                    <tr><td>åŒ…å«"11"</td><td class={analysis.contains11 ? 'success' : 'warning'}>{analysis.contains11 ? 'âœ… æ˜¯' : 'âŒ å¦'}</td></tr>
                    <tr><td>åŒ…å«"MIT"</td><td class={analysis.containsMIT ? 'success' : 'warning'}>{analysis.containsMIT ? 'âœ… æ˜¯' : 'âŒ å¦'}</td></tr>
                    <tr><td>åŒ…å«ä¸­æ–‡</td><td class={analysis.containsChinese ? 'success' : 'warning'}>{analysis.containsChinese ? 'âœ… æ˜¯' : 'âŒ å¦'}</td></tr>
                </table>
                <div class="code">å†…å®¹é¢„è§ˆ: {analysis.bodyPreview}</div>
            </div>
        ))}
    </div>

    <div class="section">
        <h2>ğŸ” æœç´¢æµ‹è¯•ç»“æœ</h2>
        {testResults.map(test => (
            <div class="result">
                <h3>æœç´¢å…³é”®è¯: "{test.keyword}"</h3>
                
                <h4>Strapiæœç´¢ç»“æœ</h4>
                {test.strapiError ? (
                    <div class="error">âŒ Strapiæœç´¢å¤±è´¥: {test.strapiError}</div>
                ) : (
                    <div class={test.strapiResults.length > 0 ? 'success' : 'warning'}>
                        æ‰¾åˆ° {test.strapiResults.length} ä¸ªç»“æœ
                        {test.strapiResults.slice(0, 3).map(result => (
                            <div>â€¢ {result.title}</div>
                        ))}
                    </div>
                )}

                <h4>æœ¬åœ°æœç´¢ç»“æœ</h4>
                {test.localError ? (
                    <div class="error">âŒ æœ¬åœ°æœç´¢å¤±è´¥: {test.localError}</div>
                ) : (
                    <div class={test.localResults.length > 0 ? 'success' : 'warning'}>
                        æ‰¾åˆ° {test.localResults.length} ä¸ªç»“æœ
                        {test.localResults.slice(0, 3).map(result => (
                            <div>
                                â€¢ {result.title} (å†…å®¹é•¿åº¦: {result.contentLength})
                                <div class="code">{result.contentPreview}</div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        ))}
    </div>

    <div class="section">
        <h2>ğŸ§ª APIæµ‹è¯•</h2>
        <div id="api-results">æ­£åœ¨æµ‹è¯•API...</div>
    </div>

    <script>
        async function testAPIs() {
            const resultsDiv = document.getElementById('api-results');
            const keywords = ['11', 'é“¶ç¿¼æ€æ‰‹', 'MIT', 'æŠ€æœ¯'];
            
            for (const keyword of keywords) {
                try {
                    const response = await fetch(`/api/search/?q=${encodeURIComponent(keyword)}`);
                    const data = await response.json();
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `
                        <h3>APIæœç´¢: "${keyword}"</h3>
                        <p class="${data.success && data.data.length > 0 ? 'success' : 'warning'}">
                            ${data.success ? `âœ… æˆåŠŸï¼Œæ‰¾åˆ° ${data.data.length} ä¸ªç»“æœ` : 'âŒ å¤±è´¥'}
                        </p>
                        ${data.data && data.data.length > 0 ? 
                            data.data.slice(0, 3).map(item => `<div>â€¢ ${item.title}</div>`).join('') : 
                            '<div>æ— ç»“æœ</div>'
                        }
                    `;
                    resultsDiv.appendChild(resultDiv);
                } catch (error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'result error';
                    errorDiv.innerHTML = `<h3>APIæœç´¢: "${keyword}"</h3><p>âŒ é”™è¯¯: ${error.message}</p>`;
                    resultsDiv.appendChild(errorDiv);
                }
            }
        }

        // é¡µé¢åŠ è½½åæµ‹è¯•API
        testAPIs();
    </script>
</body>
</html>
