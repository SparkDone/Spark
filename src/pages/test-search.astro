---
/**
 * 搜索功能测试页面
 */

import { getSortedPosts } from "../utils/strapi-content-utils";

const posts = await getSortedPosts();
const testKeyword = "11";

// 手动测试搜索逻辑
const searchResults = posts.filter(post => {
  const title = post.data.title?.toLowerCase() || '';
  const description = post.data.description?.toLowerCase() || '';
  const content = post.body?.toLowerCase() || '';
  const tags = post.data.tags?.join(' ').toLowerCase() || '';
  const category = post.data.category?.toLowerCase() || '';

  const titleMatch = title.includes(testKeyword);
  const descMatch = description.includes(testKeyword);
  const contentMatch = content.includes(testKeyword);
  const tagsMatch = tags.includes(testKeyword);
  const categoryMatch = category.includes(testKeyword);

  return titleMatch || descMatch || contentMatch || tagsMatch || categoryMatch;
});
---

<html>
<head>
    <title>搜索功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .post { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .match { background: yellow; font-weight: bold; }
        .content { max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .stats { background: #e7f3ff; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>搜索功能测试</h1>
    
    <div class="stats">
        <h2>测试统计</h2>
        <p><strong>搜索关键词:</strong> "{testKeyword}"</p>
        <p><strong>总文章数:</strong> {posts.length}</p>
        <p><strong>匹配文章数:</strong> {searchResults.length}</p>
    </div>

    <h2>API搜索测试</h2>
    <p>
        <a href={`/api/search/?q=${testKeyword}`} target="_blank">
            测试API搜索: /api/search/?q={testKeyword}
        </a>
    </p>

    <h2>匹配的文章</h2>
    {searchResults.length > 0 ? (
        searchResults.map(post => {
            const title = post.data.title || '';
            const description = post.data.description || '';
            const content = post.body || '';
            const tags = post.data.tags?.join(', ') || '';
            const category = post.data.category || '';

            const titleMatch = title.toLowerCase().includes(testKeyword);
            const descMatch = description.toLowerCase().includes(testKeyword);
            const contentMatch = content.toLowerCase().includes(testKeyword);
            const tagsMatch = tags.toLowerCase().includes(testKeyword);
            const categoryMatch = category.toLowerCase().includes(testKeyword);

            return (
                <div class="post">
                    <h3>
                        {titleMatch ? (
                            <span class="match">📍 标题匹配</span>
                        ) : null}
                        {title}
                    </h3>
                    
                    <p><strong>Slug:</strong> {post.slug}</p>
                    <p><strong>分类:</strong> 
                        {categoryMatch ? <span class="match">📍 分类匹配</span> : null}
                        {category}
                    </p>
                    <p><strong>标签:</strong> 
                        {tagsMatch ? <span class="match">📍 标签匹配</span> : null}
                        {tags}
                    </p>
                    
                    {descMatch && (
                        <div>
                            <strong>📍 描述匹配:</strong>
                            <p set:html={description.replace(new RegExp(testKeyword, 'gi'), '<span class="match">$&</span>')}></p>
                        </div>
                    )}
                    
                    {contentMatch && (
                        <div>
                            <strong>📍 内容匹配:</strong>
                            <div class="content">
                                <div set:html={content.substring(0, 1000).replace(new RegExp(testKeyword, 'gi'), '<span class="match">$&</span>')}></div>
                                {content.length > 1000 && <p>... (内容已截断)</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        })
    ) : (
        <p>❌ 没有找到匹配的文章</p>
    )}

    <h2>所有文章预览</h2>
    <details>
        <summary>点击查看所有文章的标题和内容片段</summary>
        {posts.slice(0, 5).map(post => (
            <div class="post">
                <h4>{post.data.title}</h4>
                <p><strong>内容长度:</strong> {post.body?.length || 0} 字符</p>
                <div class="content">
                    <div>{post.body?.substring(0, 200) || '无内容'}...</div>
                </div>
            </div>
        ))}
    </details>

    <script>
        // 测试前端搜索API
        async function testSearchAPI() {
            try {
                const response = await fetch('/api/search/?q=11');
                const data = await response.json();
                console.log('🔍 搜索API测试结果:', data);
                
                if (data.success && data.data.length > 0) {
                    console.log('✅ 搜索API工作正常，找到', data.data.length, '个结果');
                    data.data.forEach((item, index) => {
                        console.log(`结果 ${index + 1}:`, item.title);
                    });
                } else {
                    console.log('❌ 搜索API没有返回结果');
                }
            } catch (error) {
                console.error('❌ 搜索API测试失败:', error);
            }
        }

        // 页面加载后自动测试
        testSearchAPI();
    </script>
</body>
</html>
