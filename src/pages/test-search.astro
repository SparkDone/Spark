---
/**
 * æœç´¢åŠŸèƒ½æµ‹è¯•é¡µé¢
 */

import { getSortedPosts } from "../utils/strapi-content-utils";

const posts = await getSortedPosts();
const testKeyword = "11";

// æ‰‹åŠ¨æµ‹è¯•æœç´¢é€»è¾‘
const searchResults = posts.filter(post => {
  const title = post.data.title?.toLowerCase() || '';
  const description = post.data.description?.toLowerCase() || '';
  const content = post.body?.toLowerCase() || '';
  const tags = post.data.tags?.join(' ').toLowerCase() || '';
  const category = post.data.category?.toLowerCase() || '';

  const titleMatch = title.includes(testKeyword);
  const descMatch = description.includes(testKeyword);
  const contentMatch = content.includes(testKeyword);
  const tagsMatch = tags.includes(testKeyword);
  const categoryMatch = category.includes(testKeyword);

  return titleMatch || descMatch || contentMatch || tagsMatch || categoryMatch;
});
---

<html>
<head>
    <title>æœç´¢åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .post { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .match { background: yellow; font-weight: bold; }
        .content { max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .stats { background: #e7f3ff; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>æœç´¢åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="stats">
        <h2>æµ‹è¯•ç»Ÿè®¡</h2>
        <p><strong>æœç´¢å…³é”®è¯:</strong> "{testKeyword}"</p>
        <p><strong>æ€»æ–‡ç« æ•°:</strong> {posts.length}</p>
        <p><strong>åŒ¹é…æ–‡ç« æ•°:</strong> {searchResults.length}</p>
    </div>

    <h2>APIæœç´¢æµ‹è¯•</h2>
    <p>
        <a href={`/api/search/?q=${testKeyword}`} target="_blank">
            æµ‹è¯•APIæœç´¢: /api/search/?q={testKeyword}
        </a>
    </p>

    <h2>åŒ¹é…çš„æ–‡ç« </h2>
    {searchResults.length > 0 ? (
        searchResults.map(post => {
            const title = post.data.title || '';
            const description = post.data.description || '';
            const content = post.body || '';
            const tags = post.data.tags?.join(', ') || '';
            const category = post.data.category || '';

            const titleMatch = title.toLowerCase().includes(testKeyword);
            const descMatch = description.toLowerCase().includes(testKeyword);
            const contentMatch = content.toLowerCase().includes(testKeyword);
            const tagsMatch = tags.toLowerCase().includes(testKeyword);
            const categoryMatch = category.toLowerCase().includes(testKeyword);

            return (
                <div class="post">
                    <h3>
                        {titleMatch ? (
                            <span class="match">ğŸ“ æ ‡é¢˜åŒ¹é…</span>
                        ) : null}
                        {title}
                    </h3>
                    
                    <p><strong>Slug:</strong> {post.slug}</p>
                    <p><strong>åˆ†ç±»:</strong> 
                        {categoryMatch ? <span class="match">ğŸ“ åˆ†ç±»åŒ¹é…</span> : null}
                        {category}
                    </p>
                    <p><strong>æ ‡ç­¾:</strong> 
                        {tagsMatch ? <span class="match">ğŸ“ æ ‡ç­¾åŒ¹é…</span> : null}
                        {tags}
                    </p>
                    
                    {descMatch && (
                        <div>
                            <strong>ğŸ“ æè¿°åŒ¹é…:</strong>
                            <p set:html={description.replace(new RegExp(testKeyword, 'gi'), '<span class="match">$&</span>')}></p>
                        </div>
                    )}
                    
                    {contentMatch && (
                        <div>
                            <strong>ğŸ“ å†…å®¹åŒ¹é…:</strong>
                            <div class="content">
                                <div set:html={content.substring(0, 1000).replace(new RegExp(testKeyword, 'gi'), '<span class="match">$&</span>')}></div>
                                {content.length > 1000 && <p>... (å†…å®¹å·²æˆªæ–­)</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        })
    ) : (
        <p>âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>
    )}

    <h2>æ‰€æœ‰æ–‡ç« é¢„è§ˆ</h2>
    <details>
        <summary>ç‚¹å‡»æŸ¥çœ‹æ‰€æœ‰æ–‡ç« çš„æ ‡é¢˜å’Œå†…å®¹ç‰‡æ®µ</summary>
        {posts.slice(0, 5).map(post => (
            <div class="post">
                <h4>{post.data.title}</h4>
                <p><strong>å†…å®¹é•¿åº¦:</strong> {post.body?.length || 0} å­—ç¬¦</p>
                <div class="content">
                    <div>{post.body?.substring(0, 200) || 'æ— å†…å®¹'}...</div>
                </div>
            </div>
        ))}
    </details>

    <script>
        // æµ‹è¯•å‰ç«¯æœç´¢API
        async function testSearchAPI() {
            try {
                const response = await fetch('/api/search/?q=11');
                const data = await response.json();
                console.log('ğŸ” æœç´¢APIæµ‹è¯•ç»“æœ:', data);
                
                if (data.success && data.data.length > 0) {
                    console.log('âœ… æœç´¢APIå·¥ä½œæ­£å¸¸ï¼Œæ‰¾åˆ°', data.data.length, 'ä¸ªç»“æœ');
                    data.data.forEach((item, index) => {
                        console.log(`ç»“æœ ${index + 1}:`, item.title);
                    });
                } else {
                    console.log('âŒ æœç´¢APIæ²¡æœ‰è¿”å›ç»“æœ');
                }
            } catch (error) {
                console.error('âŒ æœç´¢APIæµ‹è¯•å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æµ‹è¯•
        testSearchAPI();
    </script>
</body>
</html>
