---
/**
 * Bannerè½®æ’­ç»„ä»¶
 * æ”¯æŒå¤šå¼ å›¾ç‰‡è½®æ’­ï¼Œä¸æ–‡ç« é¡µé¢å›¾ç‰‡ä¿æŒä¸€è‡´çš„åœ†è§’è®¾è®¡
 */

interface BannerImage {
  src: string;
  alt: string;
  title?: string;
  subtitle?: string;
  link?: string;
}

interface Props {
  images: BannerImage[];
  autoPlay?: boolean;
  interval?: number;
  showDots?: boolean;
  showArrows?: boolean;
  height?: string;
  className?: string;
}

const {
  images = [],
  autoPlay = true,
  interval = 5000,
  showDots = true,
  showArrows = true,
  height = "400px",
  className = ""
} = Astro.props;

// å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œä¸æ¸²æŸ“ç»„ä»¶
if (!images || images.length === 0) {
  return null;
}

// ç”Ÿæˆå”¯ä¸€ID
const carouselId = `banner-carousel-${Math.random().toString(36).substr(2, 9)}`;

// åˆ¤æ–­æ˜¯å¦ä¸ºå¤–éƒ¨é“¾æ¥çš„å‡½æ•°
function isExternalLink(url: string): boolean {
  if (!url) return false;

  // æ£€æŸ¥æ˜ç¡®çš„å¤–éƒ¨é“¾æ¥æ ¼å¼
  if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('//')) {
    return true;
  }

  // æ£€æŸ¥çº¯åŸŸåæ ¼å¼ï¼ˆå¦‚ baidu.com, google.comï¼‰
  if (url.includes('.') && !url.startsWith('/') && !url.includes(' ')) {
    return true;
  }

  return false;
}

// åˆ¤æ–­æ˜¯å¦ä¸ºé‚®ç®±é“¾æ¥
function isEmailLink(url: string): boolean {
  return url.startsWith('mailto:');
}

// åˆ¤æ–­æ˜¯å¦ä¸ºç”µè¯é“¾æ¥
function isTelLink(url: string): boolean {
  return url.startsWith('tel:');
}

// ä¿®æ­£é“¾æ¥æ ¼å¼ï¼Œä¸ºçº¯åŸŸåæ·»åŠ åè®®
function fixLinkFormat(url: string): string {
  if (!url) return url;

  // å¦‚æœå·²ç»æœ‰åè®®ï¼Œç›´æ¥è¿”å›
  if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('//')) {
    return url;
  }

  // å¦‚æœæ˜¯é‚®ç®±æˆ–ç”µè¯é“¾æ¥ï¼Œç›´æ¥è¿”å›
  if (url.startsWith('mailto:') || url.startsWith('tel:')) {
    return url;
  }

  // å¦‚æœæ˜¯å†…éƒ¨é“¾æ¥ï¼ˆä»¥/å¼€å¤´ï¼‰ï¼Œç›´æ¥è¿”å›
  if (url.startsWith('/')) {
    return url;
  }

  // å¦‚æœæ˜¯çº¯åŸŸåæ ¼å¼ï¼Œæ·»åŠ httpsåè®®
  if (url.includes('.') && !url.includes(' ')) {
    return `https://${url}`;
  }

  // å…¶ä»–æƒ…å†µç›´æ¥è¿”å›
  return url;
}
---

<div 
  class={`banner-carousel ${className}`}
  data-carousel-id={carouselId}
  data-auto-play={autoPlay}
  data-interval={interval}
  style={`height: ${height}`}
>
  <!-- è½®æ’­å®¹å™¨ -->
  <div class="carousel-container">
    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <div class="carousel-track" data-track>
      {images.map((image, index) => (
        <div 
          class={`carousel-slide ${index === 0 ? 'active' : ''}`}
          data-slide={index}
        >
          {image.link ? (
            <a
              href={fixLinkFormat(image.link)}
              class="slide-link"
              target={isExternalLink(image.link) ? "_blank" : "_self"}
              rel={isExternalLink(image.link) ? "noopener noreferrer" : undefined}
            >
              <img 
                src={image.src} 
                alt={image.alt}
                class="slide-image"
                loading={index === 0 ? "eager" : "lazy"}
              />
              {(image.title || image.subtitle) && (
                <div
                  class="slide-content"
                  data-text-color={image.textColor || 'light'}
                  style={image.textColorCustom ? `--custom-text-color: ${image.textColorCustom}` : ''}
                >
                  {image.title && <h3 class="slide-title">{image.title}</h3>}
                  {image.subtitle && <p class="slide-subtitle">{image.subtitle}</p>}
                </div>
              )}
            </a>
          ) : (
            <div class="slide-content-wrapper">
              <img 
                src={image.src} 
                alt={image.alt}
                class="slide-image"
                loading={index === 0 ? "eager" : "lazy"}
              />
              {(image.title || image.subtitle) && (
                <div
                  class="slide-content"
                  data-text-color={image.textColor || 'light'}
                  style={image.textColorCustom ? `--custom-text-color: ${image.textColorCustom}` : ''}
                >
                  {image.title && <h3 class="slide-title">{image.title}</h3>}
                  {image.subtitle && <p class="slide-subtitle">{image.subtitle}</p>}
                </div>
              )}
            </div>
          )}
        </div>
      ))}
    </div>

    <!-- å¯¼èˆªç®­å¤´ -->
    {showArrows && images.length > 1 && (
      <>
        <button class="carousel-arrow carousel-arrow-prev" data-prev>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="carousel-arrow carousel-arrow-next" data-next>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </>
    )}
  </div>

  <!-- æŒ‡ç¤ºç‚¹ -->
  {showDots && images.length > 1 && (
    <div class="carousel-dots">
      {images.map((_, index) => (
        <button 
          class={`carousel-dot ${index === 0 ? 'active' : ''}`}
          data-dot={index}
          aria-label={`Go to slide ${index + 1}`}
        ></button>
      ))}
    </div>
  )}
</div>

<style>
  .banner-carousel {
    position: relative;
    width: 100%;
    border-radius: var(--radius-large);
    overflow: hidden;
    background: var(--card-bg);
    box-shadow: var(--shadow-md);
  }

  .carousel-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .carousel-track {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .carousel-slide.active {
    opacity: 1;
  }

  .slide-link,
  .slide-content-wrapper {
    display: block;
    position: relative;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: inherit;
    z-index: 1; /* ç¡®ä¿é“¾æ¥åœ¨åŸºç¡€å±‚çº§ä¹‹ä¸Š */
  }

  .slide-link {
    z-index: 3; /* é“¾æ¥å±‚çº§é«˜äºå¯¼èˆªç®­å¤´å’ŒæŒ‡ç¤ºç‚¹ */
  }

  .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .slide-content {
    position: absolute;
    bottom: 0; /* ç´§è´´åº•éƒ¨ */
    left: 0;
    right: 0;
    height: 70px; /* å›ºå®šé«˜åº¦70px */
    /* é»˜è®¤éšè—æ–‡å­—å’ŒèƒŒæ™¯ */
    background-color: transparent;
    color: white;
    opacity: 0; /* é»˜è®¤å®Œå…¨éšè— */
    pointer-events: none; /* é˜²æ­¢å†…å®¹å±‚é˜»æŒ¡é“¾æ¥ç‚¹å‡» */
    /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
    transition: opacity 0.3s ease, background-color 0.3s ease, backdrop-filter 0.3s ease;
    /* ä¸Šä¸‹ä¸¤è¡Œå¸ƒå±€ */
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: flex-start; /* æ°´å¹³å·¦å¯¹é½ */
    padding: 0 20px; /* å·¦å³å†…è¾¹è· */
    border-radius: 0;
    /* é»˜è®¤æ— æ¨¡ç³Šæ•ˆæœ */
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

  .carousel-slide.active .slide-content {
    transform: translateY(0);
  }

  .slide-title {
    font-size: 1.3rem; /* è°ƒå¤§æ ‡é¢˜ */
    font-weight: 600;
    margin: 0; /* ç§»é™¤è¾¹è· */
    line-height: 1.2; /* é€‚ä¸­è¡Œé«˜ */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .slide-subtitle {
    font-size: 0.9rem; /* è°ƒå°å‰¯æ ‡é¢˜ */
    margin: 4px 0 0 0; /* ä¸æ ‡é¢˜é—´éš”4px */
    opacity: 0.9;
    line-height: 1.1; /* ç´§å‡‘è¡Œé«˜ */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  /* Banneræ‚¬åœæ—¶æ˜¾ç¤ºæ–‡å­—å’ŒèƒŒæ™¯ */
  .banner-carousel:hover .slide-content {
    opacity: 1 !important; /* æ‚¬åœæ—¶æ˜¾ç¤ºæ–‡å­— */
    background-color: rgba(0, 0, 0, 0.05) !important;
    backdrop-filter: blur(2px) !important;
    -webkit-backdrop-filter: blur(2px) !important;
  }

  /* åŠ¨æ€æ–‡å­—é¢œè‰²æ”¯æŒ - æ‚¬åœæ—¶çš„è‰²å—æ•ˆæœ */
  .banner-carousel:hover .slide-content[data-text-color="light"] {
    color: white !important;
    background-color: rgba(0, 0, 0, 0.05) !important; /* æ‚¬åœæ—¶æ˜¾ç¤ºé»‘è‰²èƒŒæ™¯ */
  }

  .banner-carousel:hover .slide-content[data-text-color="dark"] {
    color: #1a1a1a !important;
    background-color: rgba(255, 255, 255, 0.05) !important; /* æ‚¬åœæ—¶æ˜¾ç¤ºç™½è‰²èƒŒæ™¯ */
  }

  .banner-carousel:hover .slide-content[data-text-color="auto"] {
    /* è‡ªåŠ¨æ¨¡å¼æ‚¬åœæ—¶æ˜¾ç¤ºé»‘è‰²èƒŒæ™¯ */
    color: white !important;
    background-color: rgba(0, 0, 0, 0.05) !important;
  }

  /* è‡ªå®šä¹‰é¢œè‰²æ”¯æŒ */
  .slide-content[style*="--custom-text-color"] {
    color: var(--custom-text-color) !important;
  }

  /* å¼ºåˆ¶ç¡®ä¿æ ‡é¢˜å’Œå‰¯æ ‡é¢˜é¢œè‰²æ­£ç¡® */
  .banner-carousel .slide-content[data-text-color="light"],
  .slide-content[data-text-color="light"] {
    color: white !important;
  }

  .banner-carousel .slide-content[data-text-color="light"] .slide-title,
  .banner-carousel .slide-content[data-text-color="light"] .slide-subtitle,
  .slide-content[data-text-color="light"] .slide-title,
  .slide-content[data-text-color="light"] .slide-subtitle {
    color: white !important;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
  }

  .banner-carousel .slide-content[data-text-color="dark"],
  .slide-content[data-text-color="dark"] {
    color: #1a1a1a !important;
  }

  .banner-carousel .slide-content[data-text-color="dark"] .slide-title,
  .banner-carousel .slide-content[data-text-color="dark"] .slide-subtitle,
  .slide-content[data-text-color="dark"] .slide-title,
  .slide-content[data-text-color="dark"] .slide-subtitle {
    color: #1a1a1a !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5) !important;
  }

  /* è‡ªå®šä¹‰é¢œè‰²çš„æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ */
  .slide-content[style*="--custom-text-color"] .slide-title,
  .slide-content[style*="--custom-text-color"] .slide-subtitle {
    color: var(--custom-text-color) !important;
  }

  /* å¯¼èˆªç®­å¤´ - å¼ºåˆ¶è¦†ç›–æ‰€æœ‰æ ·å¼ */
  .banner-carousel .carousel-arrow,
  .carousel-arrow {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: rgba(0, 0, 0, 0.5) !important; /* 50%é€æ˜åº¦ */
    border: none !important;
    border-radius: 6px !important; /* åœ†è§’æ­£æ–¹å½¢ */
    width: 36px !important;
    height: 36px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    z-index: 10 !important; /* æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨é“¾æ¥ä¹‹ä¸Š */
    color: white !important; /* ç™½è‰²ç®­å¤´ */
    font-size: 14px !important; /* å°ç®­å¤´ */
    font-weight: bold !important; /* åŠ ç²—ç®­å¤´ï¼Œç¡®ä¿æ¸…æ™° */
    box-shadow: none !important;
  }

  .banner-carousel .carousel-arrow:hover,
  .carousel-arrow:hover {
    background: rgba(0, 0, 0, 0.5) !important; /* ä¿æŒ50%é€æ˜åº¦ */
    transform: translateY(-50%) scale(1.08) !important;
    box-shadow: none !important;
    color: white !important; /* ç¡®ä¿ç®­å¤´å§‹ç»ˆç™½è‰² */
    font-weight: bold !important; /* ç¡®ä¿ç®­å¤´å§‹ç»ˆåŠ ç²— */
  }

  .carousel-arrow-prev {
    left: 1rem;
  }

  .carousel-arrow-next {
    right: 1rem;
  }

  /* æŒ‡ç¤ºç‚¹ - å³ä¸‹è§’ä½ç½® */
  .carousel-dots {
    position: absolute;
    bottom: 1rem;
    right: 1rem; /* æ”¹ä¸ºå³ä¸‹è§’ */
    display: flex;
    gap: 0.5rem;
    z-index: 10; /* æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨é“¾æ¥ä¹‹ä¸Š */
  }

  .carousel-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .carousel-dot.active,
  .carousel-dot:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 1);
    transform: scale(1.2);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .slide-content {
      padding: 1.5rem 1rem 1rem;
    }

    .slide-title {
      font-size: 1.25rem;
    }

    .slide-subtitle {
      font-size: 0.875rem;
    }

    .carousel-arrow {
      width: 40px;
      height: 40px;
    }

    .carousel-arrow-prev {
      left: 0.5rem;
    }

    .carousel-arrow-next {
      right: 0.5rem;
    }
  }


</style>

<script>
  class BannerCarousel {
    private container: HTMLElement;
    private slides: NodeListOf<HTMLElement>;
    private dots: NodeListOf<HTMLElement>;
    private prevBtn: HTMLElement | null;
    private nextBtn: HTMLElement | null;
    private currentIndex: number = 0;
    private autoPlayInterval: number | null = null;
    private autoPlay: boolean;
    private interval: number;
    private boundHandlers: Map<string, EventListener> = new Map();

    constructor(container: HTMLElement) {
      this.container = container;
      this.slides = container.querySelectorAll('.carousel-slide');
      this.dots = container.querySelectorAll('.carousel-dot');
      this.prevBtn = container.querySelector('[data-prev]');
      this.nextBtn = container.querySelector('[data-next]');

      this.autoPlay = container.dataset.autoPlay === 'true';
      this.interval = parseInt(container.dataset.interval || '5000');

      this.init();
    }

    private init() {
      // åˆ›å»ºç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨
      const prevHandler = () => this.prev();
      const nextHandler = () => this.next();
      const mouseEnterHandler = () => this.pauseAutoPlay();
      const mouseLeaveHandler = () => this.resumeAutoPlay();
      const keydownHandler = (e: KeyboardEvent) => {
        if (e.key === 'ArrowLeft') this.prev();
        if (e.key === 'ArrowRight') this.next();
      };

      // å­˜å‚¨å¤„ç†å™¨å¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†
      this.boundHandlers.set('prev', prevHandler);
      this.boundHandlers.set('next', nextHandler);
      this.boundHandlers.set('mouseenter', mouseEnterHandler);
      this.boundHandlers.set('mouseleave', mouseLeaveHandler);
      this.boundHandlers.set('keydown', keydownHandler);

      // ç»‘å®šäº‹ä»¶
      this.prevBtn?.addEventListener('click', prevHandler);
      this.nextBtn?.addEventListener('click', nextHandler);

      this.dots.forEach((dot, index) => {
        const dotHandler = () => this.goTo(index);
        this.boundHandlers.set(`dot-${index}`, dotHandler);
        dot.addEventListener('click', dotHandler);
      });

      // é¼ æ ‡æ‚¬åœæ—¶æš‚åœè‡ªåŠ¨æ’­æ”¾
      this.container.addEventListener('mouseenter', mouseEnterHandler);
      this.container.addEventListener('mouseleave', mouseLeaveHandler);

      // é”®ç›˜å¯¼èˆª
      this.container.addEventListener('keydown', keydownHandler);

      // è§¦æ‘¸æ»‘åŠ¨æ”¯æŒ
      this.addTouchSupport();

      // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªslideä¸ºactiveçŠ¶æ€
      if (this.slides.length > 0) {
        this.slides[0].classList.add('active');
        this.dots[0]?.classList.add('active');
      }

      // å¯åŠ¨è‡ªåŠ¨æ’­æ”¾
      if (this.autoPlay && this.slides.length > 1) {
        this.startAutoPlay();
      }
    }

    private goTo(index: number) {
      if (index === this.currentIndex) return;

      // ç§»é™¤å½“å‰æ´»åŠ¨çŠ¶æ€
      this.slides[this.currentIndex]?.classList.remove('active');
      this.dots[this.currentIndex]?.classList.remove('active');

      // è®¾ç½®æ–°çš„æ´»åŠ¨çŠ¶æ€
      this.currentIndex = index;
      this.slides[this.currentIndex]?.classList.add('active');
      this.dots[this.currentIndex]?.classList.add('active');
    }

    private next() {
      const nextIndex = (this.currentIndex + 1) % this.slides.length;
      this.goTo(nextIndex);
    }

    private prev() {
      const prevIndex = (this.currentIndex - 1 + this.slides.length) % this.slides.length;
      this.goTo(prevIndex);
    }

    private startAutoPlay() {
      if (this.autoPlayInterval) return;

      this.autoPlayInterval = window.setInterval(() => {
        this.next();
      }, this.interval);
    }

    private pauseAutoPlay() {
      if (this.autoPlayInterval) {
        clearInterval(this.autoPlayInterval);
        this.autoPlayInterval = null;
      }
    }

    private resumeAutoPlay() {
      if (this.autoPlay && this.slides.length > 1) {
        this.startAutoPlay();
      }
    }

    private addTouchSupport() {
      let startX = 0;
      let startY = 0;
      let endX = 0;
      let endY = 0;

      const touchStartHandler = (e: TouchEvent) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        // æš‚åœè‡ªåŠ¨æ’­æ”¾ï¼Œé¿å…å†²çª
        this.pauseAutoPlay();
      };

      const touchEndHandler = (e: TouchEvent) => {
        endX = e.changedTouches[0].clientX;
        endY = e.changedTouches[0].clientY;

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        // åªæœ‰æ°´å¹³æ»‘åŠ¨è·ç¦»å¤§äºå‚ç›´æ»‘åŠ¨è·ç¦»æ—¶æ‰è§¦å‘
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
          if (deltaX > 0) {
            this.prev();
          } else {
            this.next();
          }
        }

        // æ¢å¤è‡ªåŠ¨æ’­æ”¾
        setTimeout(() => {
          this.resumeAutoPlay();
        }, 1000);
      };

      // å­˜å‚¨è§¦æ‘¸äº‹ä»¶å¤„ç†å™¨
      this.boundHandlers.set('touchstart', touchStartHandler);
      this.boundHandlers.set('touchend', touchEndHandler);

      this.container.addEventListener('touchstart', touchStartHandler, { passive: true });
      this.container.addEventListener('touchend', touchEndHandler, { passive: true });
    }

    // å…¬å…±æ–¹æ³•
    public destroy() {
      // åœæ­¢è‡ªåŠ¨æ’­æ”¾
      this.pauseAutoPlay();

      // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
      if (this.prevBtn && this.boundHandlers.has('prev')) {
        this.prevBtn.removeEventListener('click', this.boundHandlers.get('prev')!);
      }
      if (this.nextBtn && this.boundHandlers.has('next')) {
        this.nextBtn.removeEventListener('click', this.boundHandlers.get('next')!);
      }

      this.dots.forEach((dot, index) => {
        const handler = this.boundHandlers.get(`dot-${index}`);
        if (handler) {
          dot.removeEventListener('click', handler);
        }
      });

      // ç§»é™¤å®¹å™¨äº‹ä»¶ç›‘å¬å™¨
      if (this.boundHandlers.has('mouseenter')) {
        this.container.removeEventListener('mouseenter', this.boundHandlers.get('mouseenter')!);
      }
      if (this.boundHandlers.has('mouseleave')) {
        this.container.removeEventListener('mouseleave', this.boundHandlers.get('mouseleave')!);
      }
      if (this.boundHandlers.has('keydown')) {
        this.container.removeEventListener('keydown', this.boundHandlers.get('keydown')!);
      }

      // ç§»é™¤è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
      if (this.boundHandlers.has('touchstart')) {
        this.container.removeEventListener('touchstart', this.boundHandlers.get('touchstart')!, { passive: true } as any);
      }
      if (this.boundHandlers.has('touchend')) {
        this.container.removeEventListener('touchend', this.boundHandlers.get('touchend')!, { passive: true } as any);
      }

      // æ¸…ç†å¤„ç†å™¨æ˜ å°„
      this.boundHandlers.clear();
    }
  }

  // å­˜å‚¨è½®æ’­å®ä¾‹ï¼Œç”¨äºæ¸…ç†
  const carouselInstances = new Map<HTMLElement, BannerCarousel>();

  // åˆå§‹åŒ–æ‰€æœ‰è½®æ’­ç»„ä»¶
  function initBannerCarousels() {
    // æ¸…ç†æ—§å®ä¾‹
    carouselInstances.forEach((instance, element) => {
      instance.destroy();
    });
    carouselInstances.clear();

    // åˆå§‹åŒ–æ–°å®ä¾‹
    const carousels = document.querySelectorAll('.banner-carousel');
    carousels.forEach(carousel => {
      const instance = new BannerCarousel(carousel as HTMLElement);
      carouselInstances.set(carousel as HTMLElement, instance);
    });

    if (window.location.hostname === 'localhost') {
      console.log(`ğŸ  åˆå§‹åŒ–äº† ${carousels.length} ä¸ªè½®æ’­ç»„ä»¶`);
    }
  }

  // æ¸…ç†æ‰€æœ‰è½®æ’­å®ä¾‹
  function destroyBannerCarousels() {
    carouselInstances.forEach((instance) => {
      instance.destroy();
    });
    carouselInstances.clear();
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBannerCarousels);
  } else {
    initBannerCarousels();
  }

  // Swupé¡µé¢åˆ‡æ¢æ”¯æŒ
  if (window.swup) {
    // é¡µé¢åˆ‡æ¢å‰æ¸…ç†
    window.swup.hooks.on('content:replace', destroyBannerCarousels, { before: true });
    // é¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–
    window.swup.hooks.on('page:view', initBannerCarousels);
  } else {
    // å¦‚æœSwupè¿˜æ²¡åŠ è½½ï¼Œç›‘å¬Swupå¯ç”¨äº‹ä»¶
    document.addEventListener('swup:enable', () => {
      if (window.swup) {
        window.swup.hooks.on('content:replace', destroyBannerCarousels, { before: true });
        window.swup.hooks.on('page:view', initBannerCarousels);
      }
    });
  }
</script>
