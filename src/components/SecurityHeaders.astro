---
/**
 * å®‰å…¨å¤´ç»„ä»¶ - æ·»åŠ å®‰å…¨ç›¸å…³çš„metaæ ‡ç­¾
 */

// è·å–ç«™ç‚¹é…ç½®
import { siteConfig } from "@/config";

// è·å–å½“å‰ç¯å¢ƒ
const isDev = import.meta.env.DEV;
const isProd = import.meta.env.PROD;

// CSPç­–ç•¥ - æ”¯æŒWebAssembly (Pagefindéœ€è¦)
const csp = isDev
  ? "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' http://localhost:* ws://localhost:*; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: http: http://localhost:*; connect-src 'self' https: http: ws: http://localhost:* ws://localhost:*; frame-src 'none'; object-src 'none'"
  : "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: http:; connect-src 'self' https: http:; frame-src 'none'; object-src 'none'; upgrade-insecure-requests";

// æƒé™ç­–ç•¥
const permissionsPolicy = "camera=(), microphone=(), geolocation=(), payment=(), usb=(), autoplay=(self), fullscreen=(self)";
---

<!-- å®‰å…¨ç›¸å…³çš„metaæ ‡ç­¾ -->

<!-- å†…å®¹å®‰å…¨ç­–ç•¥ -->
<meta http-equiv="Content-Security-Policy" content={csp}>

<!-- æƒé™ç­–ç•¥ -->
<meta http-equiv="Permissions-Policy" content={permissionsPolicy}>

<!-- é˜²æ­¢MIMEç±»å‹å—…æ¢ -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">

<!-- æ³¨æ„ï¼šX-Frame-Options éœ€è¦é€šè¿‡æœåŠ¡å™¨HTTPå¤´è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡metaæ ‡ç­¾ -->

<!-- XSSä¿æŠ¤ -->
<meta http-equiv="X-XSS-Protection" content="1; mode=block">

<!-- å¼•ç”¨è€…ç­–ç•¥ -->
<meta name="referrer" content="strict-origin-when-cross-origin">

<!-- DNSé¢„å–æ§åˆ¶ -->
<meta http-equiv="x-dns-prefetch-control" content="on">

<!-- æ³¨æ„ï¼šStrict-Transport-Security éœ€è¦é€šè¿‡æœåŠ¡å™¨HTTPå¤´è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡metaæ ‡ç­¾ -->

<!-- éšç§å’Œå®‰å…¨ç›¸å…³ -->
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">

<!-- é˜²æ­¢æœç´¢å¼•æ“ç¼“å­˜æ•æ„Ÿé¡µé¢ -->
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">

<!-- ç‰ˆæƒå’Œä½œè€…ä¿¡æ¯ -->
<meta name="author" content={siteConfig.author?.name || siteConfig.title}>
<meta name="copyright" content={`Â© ${new Date().getFullYear()} ${siteConfig.title}`}>

<!-- ç½‘ç«™éªŒè¯ï¼ˆå¦‚æœéœ€è¦ï¼‰ -->
<!-- <meta name="google-site-verification" content="your-verification-code"> -->
<!-- <meta name="msvalidate.01" content="your-bing-verification-code"> -->

<!-- ç¤¾äº¤åª’ä½“å®‰å…¨ -->
<meta property="fb:app_id" content="">
<meta name="twitter:dnt" content="on">

<!-- å¼€å‘ç¯å¢ƒæç¤º -->
{isDev && (
  <!-- å¼€å‘ç¯å¢ƒå®‰å…¨æç¤º -->
  <meta name="environment" content="development">
)}

<style>
  /* é˜²æ­¢å†…å®¹å®‰å…¨ç­–ç•¥è¿è§„çš„æ ·å¼ */
  [data-csp-violation] {
    display: none !important;
  }
  
  /* å®‰å…¨ç›¸å…³çš„æ ·å¼ */
  iframe {
    display: none !important; /* ç¦æ­¢æ‰€æœ‰iframe */
  }
  
  object, embed {
    display: none !important; /* ç¦æ­¢objectå’Œembed */
  }
</style>

<script is:inline define:vars={{ isDev }}>
  // å†…å®¹å®‰å…¨ç­–ç•¥è¿è§„æŠ¥å‘Š
  if (typeof window !== 'undefined') {
    document.addEventListener('securitypolicyviolation', (e) => {
      // æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥çš„å¯å¿½ç•¥è¿è§„
      const knownIgnorableViolations = [
        'pagefind.js', // Pagefindç›¸å…³çš„WASMåŠ è½½
        'unsafe-eval', // WebAssemblyéœ€è¦çš„evalæƒé™
        'wasm-unsafe-eval' // WebAssemblyç‰¹å®šæƒé™
      ];

      const isIgnorable = knownIgnorableViolations.some(pattern =>
        e.blockedURI?.includes(pattern) ||
        e.violatedDirective?.includes(pattern) ||
        e.sourceFile?.includes(pattern)
      );

      if (isIgnorable && !isDev) {
        // ç”Ÿäº§ç¯å¢ƒä¸‹å¿½ç•¥å·²çŸ¥çš„å¯å¿½ç•¥è¿è§„
        return;
      }

      console.warn('ğŸ”’ CSPè¿è§„:', {
        blockedURI: e.blockedURI,
        violatedDirective: e.violatedDirective,
        originalPolicy: e.originalPolicy,
        sourceFile: e.sourceFile,
        lineNumber: e.lineNumber
      });

      // åœ¨å¼€å‘ç¯å¢ƒä¸‹æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
      if (isDev) {
        console.group('ğŸ”’ CSPè¿è§„è¯¦æƒ…');
        console.log('è¢«é˜»æ­¢çš„URI:', e.blockedURI);
        console.log('è¿è§„æŒ‡ä»¤:', e.violatedDirective);
        console.log('æºæ–‡ä»¶:', e.sourceFile);
        console.log('è¡Œå·:', e.lineNumber);
        console.log('æ˜¯å¦å¯å¿½ç•¥:', isIgnorable);
        console.groupEnd();

        // æä¾›ä¿®å¤å»ºè®®
        if (e.violatedDirective?.includes('script-src') && e.blockedURI?.includes('wasm')) {
          console.info('ğŸ’¡ å»ºè®®: WebAssemblyéœ€è¦åœ¨CSPä¸­æ·»åŠ  \'unsafe-eval\' æˆ– \'wasm-unsafe-eval\'');
        }
      }
    });

    // é˜²æ­¢æ§åˆ¶å°æ³¨å…¥æ”»å‡»
    const originalLog = console.log;
    console.log = function(...args) {
      // è¿‡æ»¤æ½œåœ¨çš„æ¶æ„å†…å®¹
      const filteredArgs = args.map(arg => {
        if (typeof arg === 'string' && arg.includes('<script')) {
          return '[å·²è¿‡æ»¤çš„æ½œåœ¨æ¶æ„å†…å®¹]';
        }
        return arg;
      });
      originalLog.apply(console, filteredArgs);
    };
  }
</script>
