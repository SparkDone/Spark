---
/**
 * é«˜çº§èµ„æºé¢„åŠ è½½æç¤ºç»„ä»¶ - ç¯å¢ƒæ„ŸçŸ¥çš„èµ„æºé¢„åŠ è½½
 */

// è·å–ç«™ç‚¹é…ç½®
import { siteConfig } from "@/config";

// è·å–ç¯å¢ƒå˜é‡ä¸­çš„Strapi URL - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼
const strapiUrl = import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL || 'http://localhost:1337';

// è§£æURLè·å–åŸŸåå’Œåè®®
let strapiDomain = 'localhost:1337';
let strapiProtocol = 'http:';

try {
  const url = new URL(strapiUrl);
  strapiDomain = url.host; // åŒ…å«ç«¯å£å·
  strapiProtocol = url.protocol;
} catch (error) {
  console.warn('è§£æStrapi URLå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
}

// æ ¹æ®ç¯å¢ƒåˆ¤æ–­æ˜¯å¦éœ€è¦é¢„åŠ è½½
const isDev = import.meta.env.DEV;
const isProd = import.meta.env.PROD;

// å…³é”®CSSæ–‡ä»¶ - ç§»é™¤ç¡¬ç¼–ç çš„æ–‡ä»¶åï¼Œè®©Astroè‡ªåŠ¨å¤„ç†
// è¿™äº›æ–‡ä»¶ååœ¨æ¯æ¬¡æ„å»ºæ—¶éƒ½ä¼šå˜åŒ–ï¼Œç¡¬ç¼–ç ä¼šå¯¼è‡´404é”™è¯¯
const criticalCSS = [];
// æ³¨é‡Šï¼šAstroä¼šè‡ªåŠ¨å¤„ç†CSSçš„é¢„åŠ è½½å’Œä¼˜åŒ–

// æ ¹æ®é¡µé¢ç±»å‹å†³å®šæ˜¯å¦é¢„åŠ è½½JavaScript
const currentPath = Astro.url.pathname;
const isHomePage = currentPath === '/';
const isPostPage = currentPath.startsWith('/posts/');
const isArchivePage = currentPath.startsWith('/archive');
const isCategoryPage = currentPath.startsWith('/categories/');

// ç®€åŒ–é¢„åŠ è½½ç­–ç•¥ï¼šä¸é¢„åŠ è½½æ˜“å˜çš„JavaScriptæ–‡ä»¶
// è¿™äº›æ–‡ä»¶ååœ¨æ¯æ¬¡æ„å»ºæ—¶éƒ½ä¼šå˜åŒ–ï¼Œé¢„åŠ è½½å®ƒä»¬å®¹æ˜“å¯¼è‡´404é”™è¯¯
// è®©æµè§ˆå™¨è‡ªç„¶åŠ è½½è¿™äº›æ–‡ä»¶ï¼Œç°ä»£æµè§ˆå™¨çš„ç¼“å­˜æœºåˆ¶å·²ç»è¶³å¤Ÿé«˜æ•ˆ
const criticalJS = [];
// ç§»é™¤JavaScripté¢„åŠ è½½ï¼Œé¿å…æ„å»ºåæ–‡ä»¶åå˜åŒ–å¯¼è‡´çš„404é”™è¯¯

// ç¬¬ä¸‰æ–¹åŸŸåé¢„è¿æ¥
const thirdPartyDomains = [
  'fonts.googleapis.com',
  'fonts.gstatic.com'
];

---

<!-- é«˜çº§èµ„æºé¢„åŠ è½½ä¼˜åŒ– - ç¯å¢ƒæ„ŸçŸ¥ -->

{/* 1. DNSé¢„è§£æ - æå‰è§£æåŸŸå */}
<link rel="dns-prefetch" href={`//${strapiDomain}`}>
{thirdPartyDomains.map(domain => (
  <link rel="dns-prefetch" href={`//${domain}`}>
))}

{/* 2. é¢„è¿æ¥ - å»ºç«‹è¿æ¥ */}
<link rel="preconnect" href={`${strapiProtocol}//${strapiDomain}`} crossorigin>
{thirdPartyDomains.map(domain => (
  <link rel="preconnect" href={`https://${domain}`} crossorigin>
))}

{/* 3. é¢„åŠ è½½å…³é”®CSS */}
{criticalCSS.map(css => (
  <link rel="preload" href={css} as="style">
))}

{/* 4. é¢„åŠ è½½å…³é”®JavaScript */}
{criticalJS.map(js => (
  <link rel="preload" href={js} as="script" crossorigin>
))}

{/* 5. æ¨¡å—é¢„åŠ è½½ï¼ˆç°ä»£æµè§ˆå™¨ï¼Œä»…åœ¨éœ€è¦çš„é¡µé¢ï¼‰ */}
{isProd && criticalJS.length > 0 && (
  <>
    {criticalJS.map(js => (
      <link rel="modulepreload" href={js}>
    ))}
  </>
)}

{/* å¼€å‘ç¯å¢ƒçš„é¢å¤–æç¤º */}
{isDev && (
  <>
    <!-- å¼€å‘ç¯å¢ƒèµ„æºæç¤º -->
    <link rel="dns-prefetch" href="//localhost">
    <link rel="preconnect" href="http://localhost:4321" crossorigin>
  </>
)}

{/* ç¯å¢ƒä¿¡æ¯æ³¨é‡Šï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ */}
{isDev && (
  <!--
    èµ„æºé¢„åŠ è½½é…ç½®:
    - Strapi URL: {strapiUrl}
    - Strapi Domain: {strapiDomain}
    - Environment: {import.meta.env.MODE}
    - Current Path: {currentPath}
    - Is Home Page: {isHomePage}
    - Is Post Page: {isPostPage}
    - Is Archive Page: {isArchivePage}
    - Critical JS Count: {criticalJS.length}
    - Critical JS Files: {criticalJS.join(', ')}
  -->
)}

<style>
  /* ç¡®ä¿èµ„æºæç¤ºä¸å½±å“å¸ƒå±€ */
  link[rel="dns-prefetch"],
  link[rel="preconnect"],
  link[rel="preload"] {
    display: none;
  }
</style>

<script>
  // å®¢æˆ·ç«¯èµ„æºé¢„åŠ è½½ç›‘æ§ï¼ˆä»…å¼€å‘ç¯å¢ƒä¸”éæ„å»ºæ¨¡å¼ï¼‰
  if (import.meta.env.DEV && !import.meta.env.PROD) {
    const strapiUrl = import.meta.env.STRAPI_PUBLIC_URL || import.meta.env.STRAPI_URL || 'http://localhost:1337';
    const strapiDomain = strapiUrl.replace(/^https?:\/\//, '');

    console.log('ğŸ”— èµ„æºé¢„åŠ è½½é…ç½®:', {
      strapiUrl: strapiUrl,
      strapiDomain: strapiDomain,
      environment: import.meta.env.MODE
    });

    // ç›‘æ§é¢„åŠ è½½èµ„æºçš„åŠ è½½çŠ¶æ€
    document.addEventListener('DOMContentLoaded', () => {
      const preloadLinks = document.querySelectorAll('link[rel="preload"]');
      preloadLinks.forEach(link => {
        link.addEventListener('load', () => {
          console.log('âœ… é¢„åŠ è½½æˆåŠŸ:', link.href);
        });
        link.addEventListener('error', () => {
          console.warn('âŒ é¢„åŠ è½½å¤±è´¥:', link.href);
        });
      });
    });
  }
</script>
